<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ativar NotificaÃ§Ãµes â€“ Cartomantes Online</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b0b0b;color:#fff;margin:0;padding:18px}
    .wrap{max-width:820px;margin:0 auto}
    .card{background:#151515;border:1px solid #2a2a2a;border-radius:14px;padding:16px;margin-bottom:14px}
    h1{margin:0 0 10px;font-size:20px}
    .small{font-size:12px;opacity:.85;line-height:1.35}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    button{width:100%;border-radius:12px;border:none;background:#2ecc71;color:#000;padding:14px;font-weight:900;cursor:pointer;margin-top:10px}
    button.secondary{background:#3b82f6;color:#fff}
    button.ghost{background:#222;border:1px solid #333;color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ok{color:#2ecc71}
    .err{color:#ff6b6b;white-space:pre-wrap}
    pre{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:12px;padding:12px;white-space:pre-wrap;word-break:break-word;margin:10px 0 0}
    input{width:100%;border-radius:10px;border:1px solid #333;background:#0f0f0f;color:#fff;padding:12px}
    label{display:block;margin:10px 0 6px;font-size:13px;opacity:.9}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>ðŸ”” Ativar notificaÃ§Ãµes</h1>
    <div class="small">
      Este arquivo cadastra seu celular no servidor de push.<br>
      Depois disso, as notificaÃ§Ãµes chegam mesmo com o app fechado.
    </div>
  </div>

  <div class="card">
    <label>Servidor (Render)</label>
    <input id="server" value="https://envio-6.onrender.com">

    <div class="row">
      <button id="btnAtivar">ATIVAR E CADASTRAR</button>
      <button id="btnReforcar" class="secondary">RECADASTRAR (FORÃ‡AR)</button>
    </div>

    <button id="btnStats" class="ghost">VER /stats</button>

    <div id="status" class="small" style="margin-top:10px;"></div>
    <pre id="log" class="small mono"></pre>
  </div>

</div>

<script>
const $ = id => document.getElementById(id);
const serverEl = $("server");
const statusEl = $("status");
const logEl = $("log");

function base(){ return serverEl.value.trim().replace(/\/+$/,""); }
function ok(msg){ statusEl.className="small ok"; statusEl.textContent=msg; }
function err(msg){ statusEl.className="small err"; statusEl.textContent=msg; }
function log(v){
  if(typeof v === "string") logEl.textContent = v;
  else { try{ logEl.textContent = JSON.stringify(v,null,2); }catch{ logEl.textContent = String(v); } }
}

function urlBase64ToUint8Array(base64){
  const pad="=".repeat((4-base64.length%4)%4);
  const b=(base64+pad).replace(/-/g,"+").replace(/_/g,"/");
  const raw=atob(b);
  return Uint8Array.from([...raw].map(c=>c.charCodeAt(0)));
}

async function fetchJson(url,opt){
  const r=await fetch(url,opt);
  const t=await r.text();
  let j=null; try{j=JSON.parse(t)}catch{}
  return {r,t,j};
}

async function registerSW(){
  if(!("serviceWorker"in navigator)) throw new Error("Service Worker nÃ£o suportado");
  const reg=await navigator.serviceWorker.register("./service-worker.js",{scope:"./"});
  await navigator.serviceWorker.ready;
  return reg;
}

async function getVapid(){
  const u = base()+"/vapid-public-key?t="+Date.now(); // âœ… anti-cache
  const {r,j,t}=await fetchJson(u,{cache:"no-store"});
  log(j||t);
  if(!r.ok||!j?.publicKey) throw new Error("Falha ao obter VAPID");
  return j.publicKey;
}

async function saveSub(sub){
  const payload = (typeof sub.toJSON === "function") ? sub.toJSON() : sub; // âœ… garante JSON real
  const u = base()+"/save-subscription?t="+Date.now(); // âœ… anti-cache
  const {r,j,t}=await fetchJson(u,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  log(j||t);
  if(!r.ok) throw new Error("Erro ao salvar subscription: " + (j?.error || t));
  return j;
}

async function ensureSub(force=false){
  const perm=await Notification.requestPermission();
  if(perm!=="granted") throw new Error("PermissÃ£o negada: "+perm);

  const reg=await registerSW();
  const vapid=await getVapid();

  let sub=await reg.pushManager.getSubscription();
  if(force && sub){ try{await sub.unsubscribe()}catch{} sub=null; }

  if(!sub){
    sub=await reg.pushManager.subscribe({
      userVisibleOnly:true,
      applicationServerKey:urlBase64ToUint8Array(vapid)
    });
  }

  return await saveSub(sub);
}

$("btnAtivar").onclick=async()=>{
  ok("Ativando...");
  log("");
  try{
    const r=await ensureSub(false);
    ok("âœ… Cadastrado! Total: "+(r.total ?? "?"));
  }catch(e){ err(e.message||e); }
};

$("btnReforcar").onclick=async()=>{
  ok("ReforÃ§ando cadastro...");
  log("");
  try{
    const r=await ensureSub(true);
    ok("âœ… Reinscrito! Total: "+(r.total ?? "?"));
  }catch(e){ err(e.message||e); }
};

$("btnStats").onclick=async()=>{
  ok("Consultando stats...");
  log("");
  try{
    const u = base()+"/stats?t="+Date.now(); // âœ… anti-cache
    const {r,j,t}=await fetchJson(u,{cache:"no-store"});
    log(j||t);
    if(!r.ok) throw new Error("Erro /stats: "+t);
    ok("Total no servidor: "+j.total);
  }catch(e){ err(e.message||e); }
};

ok("PermissÃ£o atual: "+(window.Notification ? Notification.permission : "N/A"));
</script>
</body>
</html>
