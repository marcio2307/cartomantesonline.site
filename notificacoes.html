<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ativar Notifica√ß√µes - Cartomantes Online</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b0b0b;color:#fff;margin:0;padding:18px}
    .wrap{max-width:820px;margin:0 auto}
    .card{background:#151515;border:1px solid #2a2a2a;border-radius:14px;padding:16px;margin-bottom:14px}
    h1{margin:0 0 10px;font-size:20px}
    .small{font-size:12px;opacity:.85;line-height:1.35}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    button{width:100%;box-sizing:border-box;border-radius:12px;border:none;background:#2ecc71;color:#000;padding:14px;font-weight:900;cursor:pointer;margin-top:10px}
    button.secondary{background:#3b82f6;color:#fff}
    button.ghost{background:#222;border:1px solid #333;color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ok{color:#2ecc71}
    .err{color:#ff6b6b;white-space:pre-wrap}
    pre{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:12px;padding:12px;white-space:pre-wrap;word-break:break-word;margin:10px 0 0}
    input{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid #333;background:#0f0f0f;color:#fff;padding:12px}
    label{display:block;margin:10px 0 6px;font-size:13px;opacity:.9}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üîî Ativar notifica√ß√µes (cadastro no servidor)</h1>
      <div class="small">
        Este arquivo √© o respons√°vel por <b>cadastrar o seu celular</b> no Render via <span class="mono">/save-subscription</span>.
        <br><br>
        ‚úÖ Depois de cadastrar, o painel de envio consegue entregar as notifica√ß√µes.
      </div>
    </div>

    <div class="card">
      <label>Servidor (Render)</label>
      <input id="server" value="https://envio-6.onrender.com" />

      <div class="row">
        <button id="btnActivate" type="button">ATIVAR E CADASTRAR</button>
        <button id="btnResub" class="secondary" type="button">RECADASTRAR (FOR√áAR NOVA)</button>
      </div>

      <button id="btnStats" class="ghost" type="button">VER /stats</button>

      <div id="status" class="small" style="margin-top:10px;"></div>
      <pre id="log" class="small mono"></pre>
    </div>

    <div class="card">
      <div class="small">
        ‚úÖ Se o cadastro der certo, o <span class="mono">/stats</span> deve subir para <b>1</b> (ou mais).
        <br>
        ‚ö†Ô∏è Se aparecer erro aqui, copie e me mande o texto do log.
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const serverEl = $("server");
  const btnActivate = $("btnActivate");
  const btnResub = $("btnResub");
  const btnStats = $("btnStats");
  const statusEl = $("status");
  const logEl = $("log");

  function serverBase(){
    return serverEl.value.trim().replace(/\/+$/,"");
  }

  function setStatusOk(msg){
    statusEl.className = "small ok";
    statusEl.textContent = msg;
  }
  function setStatusErr(msg){
    statusEl.className = "small err";
    statusEl.textContent = msg;
  }
  function setLog(objOrText){
    if(typeof objOrText === "string") logEl.textContent = objOrText;
    else {
      try{ logEl.textContent = JSON.stringify(objOrText, null, 2); }
      catch{ logEl.textContent = String(objOrText); }
    }
  }

  function urlBase64ToUint8Array(base64String){
    const padding = "=".repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const raw = atob(base64);
    return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
  }

  async function fetchJsonOrText(url, opts){
    const res = await fetch(url, opts);
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch {}
    return { res, text, json };
  }

  async function getVapidKey(){
    // cache no-store pra evitar pegar resposta antiga
    const { res, text, json } = await fetchJsonOrText(serverBase() + "/vapid-public-key", { cache:"no-store" });
    setLog(json || text);
    if(!res.ok) throw new Error("Falha ao obter /vapid-public-key: " + text);
    if(!json?.publicKey) throw new Error("Servidor n√£o retornou publicKey.");
    return json.publicKey;
  }

  async function registerSW(){
    if(!("serviceWorker" in navigator)) throw new Error("Service Worker n√£o suportado neste navegador.");

    // ‚úÖ garante que o SW antigo est√° atualizado (evita ficar preso num SW velho)
    const reg = await navigator.serviceWorker.register("./service-worker.js", { scope:"./" });
    try { await reg.update(); } catch {}

    await navigator.serviceWorker.ready;

    // ‚úÖ se estiver esperando (waiting), for√ßa ele assumir mais r√°pido
    if (reg.waiting) {
      try { reg.waiting.postMessage({ type: "SKIP_WAITING" }); } catch {}
    }

    return reg;
  }

  async function saveSubscription(sub){
    // ‚úÖ IMPORTANT√çSSIMO: enviar somente JSON plano (toJSON)
    const payload = (sub && typeof sub.toJSON === "function") ? sub.toJSON() : sub;

    const { res, text, json } = await fetchJsonOrText(serverBase() + "/save-subscription", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    setLog(json || text);

    if(!res.ok){
      throw new Error(`Falha ao salvar subscription (HTTP ${res.status}): ${json?.error || text}`);
    }
    return json;
  }

  async function ensureSubscription(forceNew=false){
    if(!("Notification" in window)) throw new Error("Este navegador n√£o suporta Notification API.");

    // ‚úÖ em alguns celulares precisa de gesto do usu√°rio (clique) ‚Äî aqui j√° estamos no clique
    const perm = await Notification.requestPermission();
    if(perm !== "granted") throw new Error("Permiss√£o n√£o concedida. (Permission = " + perm + ")");

    const reg = await registerSW();
    const vapid = await getVapidKey();

    let sub = await reg.pushManager.getSubscription();

    // ‚úÖ Se j√° existe, SEMPRE salva de novo no servidor (Render pode ter reiniciado e perdido o arquivo/mem√≥ria)
    // ‚úÖ Se forceNew=true, a√≠ sim desinscreve e cria outra.
    if(forceNew && sub){
      try{ await sub.unsubscribe(); }catch{}
      sub = null;
    }

    if(!sub){
      sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(vapid)
      });
    }

    const saved = await saveSubscription(sub);
    return { sub, saved };
  }

  async function stats(){
    const { res, text, json } = await fetchJsonOrText(serverBase() + "/stats", { cache:"no-store" });
    setLog(json || text);
    if(!res.ok) throw new Error("Erro /stats: " + text);
    return json;
  }

  btnStats.addEventListener("click", async () => {
    btnStats.disabled = true;
    try{
      setStatusOk("Consultando /stats...");
      const s = await stats();
      setStatusOk("‚úÖ /stats OK ‚Äî total inscri√ß√µes: " + (s?.total ?? "?"));
    }catch(e){
      setStatusErr("‚ùå " + (e?.message || e));
    }finally{
      btnStats.disabled = false;
    }
  });

  btnActivate.addEventListener("click", async () => {
    btnActivate.disabled = true;
    btnResub.disabled = true;
    btnStats.disabled = true;
    setLog("");
    try{
      setStatusOk("Ativando e cadastrando...");
      const { saved } = await ensureSubscription(false);
      setStatusOk("‚úÖ Cadastrado no servidor! Total agora: " + (saved?.total ?? "?") + " (clique em /stats para confirmar)");
    }catch(e){
      setStatusErr("‚ùå ERRO ao cadastrar:\n" + (e?.message || e));
    }finally{
      btnActivate.disabled = false;
      btnResub.disabled = false;
      btnStats.disabled = false;
    }
  });

  btnResub.addEventListener("click", async () => {
    btnActivate.disabled = true;
    btnResub.disabled = true;
    btnStats.disabled = true;
    setLog("");
    try{
      setStatusOk("For√ßando novo cadastro (reinscrevendo)...");
      const { saved } = await ensureSubscription(true);
      setStatusOk("‚úÖ RECADASTRADO! Total agora: " + (saved?.total ?? "?") + " (clique em /stats para confirmar)");
    }catch(e){
      setStatusErr("‚ùå ERRO ao recadastrar:\n" + (e?.message || e));
    }finally{
      btnActivate.disabled = false;
      btnResub.disabled = false;
      btnStats.disabled = false;
    }
  });

  // status inicial
  (async () => {
    try{
      if(!("Notification" in window)){
        setStatusErr("‚ùå Este navegador n√£o suporta Notification API.");
        return;
      }
      setStatusOk("Permiss√£o atual: " + Notification.permission + " | Clique em ATIVAR para cadastrar. Depois veja /stats.");
    }catch{}
  })();
</script>

<!-- ‚úÖ AJUDA: para o SW assumir r√°pido (opcional, mas ajuda no iOS/Android) -->
<script>
  // Se voc√™ usar esse SW, ele precisa ouvir SKIP_WAITING.
  // (n√£o quebra se n√£o ouvir; apenas ignora)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.addEventListener("message", () => {});
  }
</script>

</body>
</html>
