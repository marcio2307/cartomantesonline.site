<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ativar Notifica√ß√µes ‚Äì Cartomantes Online</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b0b0b;color:#fff;margin:0;padding:18px}
    .wrap{max-width:820px;margin:0 auto}
    .card{background:#151515;border:1px solid #2a2a2a;border-radius:14px;padding:16px;margin-bottom:14px}
    h1{margin:0 0 10px;font-size:20px}
    .small{font-size:12px;opacity:.85;line-height:1.35;white-space:pre-wrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New", monospace}
    button{width:100%;border-radius:12px;border:none;background:#2ecc71;color:#000;padding:14px;font-weight:900;cursor:pointer;margin-top:10px}
    button.secondary{background:#3b82f6;color:#fff}
    button.ghost{background:#222;border:1px solid #333;color:#fff}
    button.warn{background:#f59e0b;color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ok{color:#2ecc71}
    .err{color:#ff6b6b;white-space:pre-wrap}
    pre{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:12px;padding:12px;white-space:pre-wrap;word-break:break-word;margin:10px 0 0}
    input{width:100%;border-radius:10px;border:1px solid #333;background:#0f0f0f;color:#fff;padding:12px}
    label{display:block;margin:10px 0 6px;font-size:13px;opacity:.9}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>üîî Ativar notifica√ß√µes</h1>
    <div class="small">
      Este arquivo cadastra seu celular no servidor de push.<br>
      Depois disso, as notifica√ß√µes chegam mesmo com o app fechado (Android/Chrome).
    </div>
    <div class="small" style="margin-top:8px">
      Permiss√£o atual: <span class="mono" id="perm"></span>
    </div>
    <div class="small" style="margin-top:6px">
      SW scope detectado: <span class="mono" id="scopeInfo"></span>
    </div>
  </div>

  <div class="card">
    <label>Servidor (Render)</label>
    <input id="server" value="https://envio-7.onrender.com">

    <label>Token (opcional)</label>
    <input id="token" placeholder="Se voc√™ tiver ADMIN_TOKEN no Render, coloque aqui (opcional)">

    <div class="row">
      <button id="btnAtivar">ATIVAR E CADASTRAR</button>
      <button id="btnReforcar" class="secondary">RECADASTRAR (FOR√áAR)</button>
    </div>

    <button id="btnTestar" class="warn">üß™ TESTAR ENVIO AGORA (POST /send)</button>
    <button id="btnStats" class="ghost">VER /stats</button>
    <button id="btnDiag" class="ghost">VER /diag</button>

    <div id="status" class="small" style="margin-top:10px;"></div>
    <pre id="log" class="small mono"></pre>
  </div>

  <div class="card">
    <div class="small">
      ‚úÖ Se o teste mostrar <b>success: 0</b>, olhe em <b>results</b> o <b>statusCode</b> e <b>error</b> ‚Äî isso diz por que n√£o chega.<br>
      ‚úÖ Se aparecer ‚ÄúVAPID public key must be on the P-256 curve‚Äù, voc√™ ainda est√° com inscri√ß√µes antigas. Use <b>RECADASTRAR (FOR√áAR)</b> e teste de novo.
    </div>
  </div>

</div>

<script>
const $ = id => document.getElementById(id);
const serverEl = $("server");
const tokenEl = $("token");
const statusEl = $("status");
const logEl = $("log");
const permEl = $("perm");
const scopeInfoEl = $("scopeInfo");

permEl.textContent = (window.Notification ? Notification.permission : "indispon√≠vel");

function base(){
  return serverEl.value.trim().replace(/\/+$/,"");
}

function ok(msg){
  statusEl.className="small ok";
  statusEl.textContent=msg;
}
function err(msg){
  statusEl.className="small err";
  statusEl.textContent=msg;
}
function log(v){
  try{ logEl.textContent = JSON.stringify(v,null,2); }
  catch{ logEl.textContent = String(v); }
}

// ‚úÖ GitHub Pages precisa scope fixo: "/NOME-REPO/"
function detectScopeBase(){
  const parts = location.pathname.split("/").filter(Boolean);
  if (location.hostname.endsWith("github.io") && parts.length > 0) return `/${parts[0]}/`;
  return "/";
}
const SCOPE_BASE = detectScopeBase();
const SW_URL = `${SCOPE_BASE}service-worker.js`;
scopeInfoEl.textContent = `scope=${SCOPE_BASE} sw=${SW_URL}`;

function urlBase64ToUint8Array(base64){
  const pad="=".repeat((4-base64.length%4)%4);
  const b=(base64+pad).replace(/-/g,"+").replace(/_/g,"/");
  const raw=atob(b);
  return Uint8Array.from([...raw].map(c=>c.charCodeAt(0)));
}

async function fetchJson(url,opt){
  const r=await fetch(url,opt);
  const t=await r.text();
  let j=null; try{j=JSON.parse(t)}catch{}
  return {r,t,j};
}

async function registerSW(){
  if(!("serviceWorker"in navigator)) throw new Error("Service Worker n√£o suportado");
  if(!isSecureContext) throw new Error("Push s√≥ funciona em HTTPS.");
  const reg=await navigator.serviceWorker.register(SW_URL,{ scope:SCOPE_BASE });
  await navigator.serviceWorker.ready;
  try{ await reg.update(); }catch{}
  return reg;
}

async function getVapid(){
  const {r,j,t}=await fetchJson(base()+"/vapid-public-key?t="+Date.now(),{cache:"no-store"});
  log(j||t);
  if(!r.ok||!j?.publicKey) throw new Error("Falha ao obter VAPID");
  return j.publicKey;
}

async function saveSub(sub){
  const subJson = (typeof sub?.toJSON === "function") ? sub.toJSON() : sub;
  const {r,j,t}=await fetchJson(base()+"/save-subscription",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(subJson)
  });
  log(j||t);
  if(!r.ok) throw new Error("Erro ao salvar subscription");
  return j;
}

async function ensureSub(force=false){
  if(!("Notification" in window)) throw new Error("Notifica√ß√µes n√£o suportadas neste aparelho/navegador.");
  const perm=await Notification.requestPermission();
  permEl.textContent = perm;
  if(perm!=="granted") throw new Error("Permiss√£o negada");

  const reg=await registerSW();
  const vapid=await getVapid();

  let sub=await reg.pushManager.getSubscription();

  // ‚úÖ FOR√áAR: descadastra e cadastra de novo (resolve troca de VAPID)
  if(force && sub){
    try{ await sub.unsubscribe(); }catch{}
    sub=null;
  }

  if(!sub){
    sub=await reg.pushManager.subscribe({
      userVisibleOnly:true,
      applicationServerKey:urlBase64ToUint8Array(vapid)
    });
  }

  const saved=await saveSub(sub);
  return { saved, sub };
}

async function sendTest(){
  const api = base();
  const token = tokenEl.value.trim();

  const payload = {
    title: "Teste Cartomantes Online",
    body: "Se voc√™ recebeu isso, o Push est√° funcionando ‚úÖ",
    url: "https://marcio2307.github.io/cartomantesonline.site/leituras.html"
  };

  const headers = { "Content-Type":"application/json" };
  if(token) headers["x-admin-token"] = token;

  const {r,j,t} = await fetchJson(api + "/send?t=" + Date.now(), {
    method:"POST",
    headers,
    body: JSON.stringify(payload),
    cache:"no-store"
  });

  log(j || t);
  if(!r.ok){
    const msg = j?.error ? j.error : t;
    throw new Error(`HTTP ${r.status}: ${msg}`);
  }
  return j;
}

$("btnAtivar").onclick=async()=>{
  ok("Ativando...");
  try{
    const r=await ensureSub(false);
    ok("‚úÖ Cadastrado! Total: "+r.saved.total);
  }catch(e){ err(e.message||e); }
};

$("btnReforcar").onclick=async()=>{
  ok("Refor√ßando cadastro (FOR√áAR)...");
  try{
    const r=await ensureSub(true);
    ok("‚úÖ Reinscrito! Total: "+r.saved.total);
  }catch(e){ err(e.message||e); }
};

$("btnStats").onclick=async()=>{
  ok("Consultando stats...");
  try{
    const {r,j,t}=await fetchJson(base()+"/stats?t="+Date.now(),{cache:"no-store"});
    log(j||t);
    if(!r.ok) throw new Error("Erro /stats");
    ok("Total no servidor: "+j.total);
  }catch(e){ err(e.message||e); }
};

$("btnDiag").onclick=async()=>{
  ok("Consultando diag...");
  try{
    const {r,j,t}=await fetchJson(base()+"/diag?t="+Date.now(),{cache:"no-store"});
    log(j||t);
    if(!r.ok) throw new Error("Erro /diag");
    ok("‚úÖ /diag OK (veja o log)");
  }catch(e){ err(e.message||e); }
};

$("btnTestar").onclick=async()=>{
  ok("Preparando teste...");
  try{
    // garante cadastrado ANTES do teste
    await ensureSub(false);
    ok("Enviando teste via /send...");
    const resp = await sendTest();
    ok(`‚úÖ Enviado! success: ${resp.success} | fail: ${resp.fail} | removed: ${resp.removed} | alive: ${resp.alive}`);
  }catch(e){
    err("‚ùå Falha no teste:\n" + (e?.message || e));
  }
};

ok("Pronto. Clique em RECADASTRAR (FOR√áAR) e depois em TESTAR.");
</script>
</body>
</html>
