<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Consultores Disponíveis</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

<style>
:root{
  --gold-1:#fff0a6;
  --gold-2:#f6e27a;
  --gold-3:#c7a008;
  --gold-4:#b8860b;
  --black:#000000;
  --btn-h:56px;
  --btn-px:14px;
}

body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(900px 420px at 15% 10%, rgba(199,160,8,0.20), rgba(0,0,0,0) 60%),
    radial-gradient(900px 420px at 85% 20%, rgba(199,160,8,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(1200px 520px at 50% 120%, rgba(199,160,8,0.10), rgba(0,0,0,0) 65%),
    #000;
  font-family:'Poppins',sans-serif;
  color:#fff;
}

/* ✅ CARROSSEL DE BANNERS (SEM CORTE) */
.banner-carousel{
  width:100%;
  margin:0;
  border-bottom:2px solid var(--gold-3);
  box-shadow:0 18px 60px rgba(0,0,0,0.55);
  position:relative;
  background:#000;
  overflow:hidden;
}
.banner-carousel::after{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(1200px 520px at 50% 15%, rgba(0,0,0,0.10), rgba(0,0,0,0.48) 60%),
    linear-gradient(180deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.35) 100%);
  pointer-events:none;
  z-index:3;
}
.banner-carousel .slide{
  position:absolute;
  inset:0;
  opacity:0;
  transition:opacity .45s ease;
  z-index:1;
}
.banner-carousel .slide.active{
  opacity:1;
  z-index:2;
}
.banner-carousel img{
  width:100%;
  height:auto;
  display:block;
}
.banner-carousel .spacer{
  width:100%;
  pointer-events:none;
}
.banner-carousel .spacer img{
  opacity:0;
  visibility:hidden;
}

@media (max-width:480px){
  .banner-carousel{ border-bottom-width:1px; }
  :root{ --btn-h:64px; --btn-px:16px; }
}

.page{ padding:22px 20px 28px; }

/* Hero */
.hero{
  max-width:1200px;
  margin:0 auto 22px;
  text-align:center;
  padding:0 10px;
}
.hero h1{
  margin:0 0 10px;
  font-size:36px;
  font-weight:800;
  letter-spacing:0.2px;
  color:transparent;
  background-image: linear-gradient(180deg, var(--gold-2) 0%, var(--gold-3) 42%, var(--gold-1) 72%, var(--gold-4) 100%);
  -webkit-background-clip:text;
  background-clip:text;
  text-shadow:0 0 22px rgba(199,160,8,0.15);
}

/* ✅ AVISO */
.hero .vip-aviso{
  display:flex;
  justify-content:center;
  width:100%;
  margin:14px auto 0;
}
.hero .vip-aviso a{
  width:min(760px, 100%);
  min-height:66px;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:16px 16px;
  border-radius:20px;
  text-decoration:none;
  font-weight:900;
  letter-spacing:.4px;
  line-height:1.25;
  color:#111;
  background:linear-gradient(180deg, var(--gold-1) 0%, var(--gold-2) 45%, var(--gold-3) 100%);
  border:1px solid rgba(255,255,255,0.18);
  box-shadow:
    0 22px 46px rgba(0,0,0,0.65),
    0 0 0 1px rgba(255,240,166,0.10) inset;
  text-transform:uppercase;
  -webkit-tap-highlight-color: transparent;
}
.hero .vip-aviso a:hover{ filter:brightness(1.05); }
.hero .vip-aviso a:active{ transform: translateY(1px); }

@media (max-width:480px){
  .hero .vip-aviso{ margin-top:12px; }
  .hero .vip-aviso a{
    width:100%;
    min-height:74px;
    padding:16px 14px;
    font-size:13px;
    letter-spacing:.35px;
    border-radius:18px;
  }
}

/* Grid */
.container{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:20px;
  max-width:1200px;
  margin:0 auto;
}
@media (max-width:1024px){ .container{ grid-template-columns:repeat(3,1fr); } }
@media (max-width:768px){
  .container{ grid-template-columns:repeat(2,1fr); gap:15px; }
  .hero h1{ font-size:30px; }
}
@media (max-width:480px){
  .container{ grid-template-columns:repeat(2,1fr); gap:12px; }
  .hero h1{ font-size:26px; }
}

/* Cards */
.card{
  position:relative;
  border-radius:18px;
  overflow:hidden;
  isolation:isolate;
  background:
    radial-gradient(560px 260px at 50% -10%, rgba(199,160,8,0.25), rgba(0,0,0,0) 60%),
    linear-gradient(180deg, rgba(18,18,18,0.86) 0%, rgba(5,5,5,0.98) 100%);
  border:1px solid rgba(199,160,8,0.55);
  box-shadow:
    0 18px 44px rgba(0,0,0,0.60),
    0 0 0 1px rgba(255,240,166,0.08) inset;
  transform:none !important;
  transition:none;
}
.card::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(520px 220px at 50% 0%, rgba(246,226,122,0.22), rgba(0,0,0,0) 60%),
    radial-gradient(180px 120px at 18% 18%, rgba(255,240,166,0.10), rgba(0,0,0,0) 70%),
    radial-gradient(180px 120px at 82% 28%, rgba(255,240,166,0.08), rgba(0,0,0,0) 70%);
  opacity:.9;
  pointer-events:none;
  z-index:0;
}
.card::after{
  content:"";
  position:absolute;
  inset:0;
  background:
    linear-gradient(120deg,
      rgba(255,240,166,0.00) 0%,
      rgba(255,240,166,0.04) 28%,
      rgba(255,240,166,0.00) 55%,
      rgba(255,240,166,0.00) 100%);
  mix-blend-mode:screen;
  opacity:.55;
  pointer-events:none;
  z-index:1;
}
.card:hover{
  border-color:rgba(246,226,122,0.95);
  box-shadow:
    0 18px 44px rgba(0,0,0,0.60),
    0 0 30px rgba(199,160,8,0.14),
    0 0 0 1px rgba(255,240,166,0.10) inset;
}

.card .img-wrap{ position:relative; z-index:2; padding:10px 10px 0; }
.card .img-wrap img{
  width:100%;
  height:240px;
  object-fit:cover;
  display:block;
  border-radius:14px;
  border:1px solid rgba(199,160,8,0.35);
  box-shadow:
    0 12px 30px rgba(0,0,0,0.55),
    0 0 0 1px rgba(255,240,166,0.06) inset;
  filter:saturate(1.06) contrast(1.06);
}
.card .img-wrap::after{
  content:"";
  position:absolute;
  left:10px; right:10px; bottom:0;
  height:86px;
  border-radius:0 0 14px 14px;
  background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.85) 100%);
  pointer-events:none;
}

/* Badge */
.badge{
  position:absolute;
  top:16px; left:16px;
  padding:7px 11px;
  font-size:11px;
  border-radius:999px;
  text-transform:uppercase;
  color:#fff;
  font-weight:900;
  letter-spacing:0.6px;
  box-shadow:0 10px 18px rgba(0,0,0,0.50);
  z-index:4;
  border:1px solid rgba(255,255,255,0.18);
  background:linear-gradient(180deg, #2ecc71 0%, #1f9b50 100%);
}
.badge.ocupado{ background:linear-gradient(180deg, #f39c12 0%, #d35400 100%); }
.badge.indisp{ background:linear-gradient(180deg, #e74c3c 0%, #c0392b 100%); }

.content{ padding:12px 14px 16px; position:relative; z-index:3; }

.name{
  font-family:'Cinzel', serif;
  font-size:16px;
  font-weight:800;
  text-align:center;
  margin:6px 0 8px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:8px;
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-1) 0%, var(--gold-3) 52%, var(--gold-2) 100%);
  -webkit-background-clip:text;
  background-clip:text;
  text-shadow:0 0 18px rgba(199,160,8,0.12);
}

.dot{
  width:9px; height:9px;
  border-radius:50%;
  background:#2ecc71;
  animation:blink 1s infinite;
  box-shadow:0 0 12px rgba(46,204,113,0.40);
}
@keyframes blink{ 50%{ opacity:0; } }
.dot.ocupado{ background:#e67e22; animation:none; box-shadow:none; }
.dot.indisp{ background:#e74c3c; animation:none; box-shadow:none; }

.stars{
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2) 0%, var(--gold-3) 55%, var(--gold-4) 100%);
  -webkit-background-clip:text;
  background-clip:text;
  text-align:center;
  margin-bottom:8px;
  font-size:14px;
  text-shadow:0 0 18px rgba(199,160,8,0.12);
}

.price{ text-align:center; font-size:13px; color:rgba(255,255,255,0.90); margin-bottom:12px; }
.price b{
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2) 0%, var(--gold-3) 45%, var(--gold-1) 80%);
  -webkit-background-clip:text;
  background-clip:text;
}

/* Botões */
.btn{
  width:100%;
  height:var(--btn-h);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:0 var(--btn-px);
  border-radius:16px;
  text-decoration:none;
  font-weight:900;
  font-size:13px;
  letter-spacing:0.7px;
  line-height:1.15;
  white-space:normal;
  overflow:visible;
  box-sizing:border-box;
  box-shadow: 0 16px 30px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,240,166,0.06) inset;
  border:1px solid rgba(255,255,255,0.10);
  transition:filter .18s ease;
}
@media (max-width:480px){ .btn{ font-size:12px; } }

.btn.disponivel{ background:linear-gradient(180deg, #2ecc71 0%, #1f9b50 100%); color:#fff; border-color:rgba(255,255,255,0.16); }
.btn:hover{ filter:brightness(1.06); }
.btn.ocupado{ background:linear-gradient(180deg, #f39c12 0%, #d35400 100%); color:#111; pointer-events:none; }
.btn.indisp{ background:linear-gradient(180deg, #e74c3c 0%, #c0392b 100%); color:#fff; pointer-events:none; }

.card.novo{
  border-color:rgba(246,226,122,0.95);
  box-shadow: 0 20px 50px rgba(0,0,0,0.62), 0 0 0 1px rgba(246,226,122,0.10) inset, 0 0 22px rgba(199,160,8,0.10);
}

/* ✅ Popup permissão notificações (estilo app) */
#notifPopupWrap{
  position:fixed;
  inset:0;
  z-index:999999;
  display:none;
  align-items:flex-end;
  justify-content:center;
  padding:14px;
  background:rgba(0,0,0,.35);
  backdrop-filter: blur(2px);
}
#notifPopup{
  width:min(560px, 100%);
  border:1px solid rgba(199,160,8,.55);
  border-radius:18px;
  padding:14px;
  background:rgba(0,0,0,.92);
  color:#fff;
  box-shadow:0 26px 70px rgba(0,0,0,.65);
}
#notifPopup .t{ font-weight:900; margin-bottom:6px; }
#notifPopup .d{ opacity:.9; font-size:13px; line-height:1.4; margin-bottom:12px; }
#notifPopup .row{ display:flex; gap:10px; flex-wrap:wrap; }
#notifPopup button{
  height:48px;
  border:0;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  letter-spacing:.5px;
}
#notifEnable{ flex:1; min-width:160px; background:linear-gradient(180deg,#2ecc71,#1f9b50); color:#fff; }
#notifLater{ width:140px; background:rgba(255,255,255,.10); color:#fff; border:1px solid rgba(255,255,255,.12); }
#notifOk{ flex:1; min-width:160px; background:linear-gradient(180deg, var(--gold-2), var(--gold-3)); color:#111; display:none; }

/* ✅ Mini botão fixo (se popup não aparecer, o usuário consegue ativar) */
#notifFab{
  position:fixed;
  right:14px;
  bottom:14px;
  z-index:999998;
  display:none;
  align-items:center;
  justify-content:center;
  height:52px;
  padding:0 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.78);
  color:#fff;
  font-weight:900;
  letter-spacing:.4px;
  box-shadow:0 18px 50px rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
}
#notifFab .p{
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2), var(--gold-3));
  -webkit-background-clip:text;
  background-clip:text;
}
#notifFab .dot{
  width:9px;height:9px;border-radius:50%;
  background:#f39c12;
  box-shadow:0 0 10px rgba(243,156,18,.35);
  margin-right:8px;
}
#notifFab.enabled .dot{ background:#2ecc71; box-shadow:0 0 12px rgba(46,204,113,.35); }

/* ✅ BLOQUEIO DE PROPAGANDAS INJETADAS (FabApp / similares) */
fabapp-banner-footer,
fabapp-banner-footer *{
  display:none !important;
  visibility:hidden !important;
  opacity:0 !important;
  height:0 !important;
  max-height:0 !important;
  min-height:0 !important;
  width:0 !important;
  max-width:0 !important;
  overflow:hidden !important;
  pointer-events:none !important;
}
#ads-container,
[id="ads-container"],
[id*="ads-container"],
[class*="ads-container"],
iframe[src*="fabapp-ads"],
video[src*="fabapp-ads"],
source[src*="fabapp-ads"]{
  display:none !important;
  visibility:hidden !important;
  opacity:0 !important;
  height:0 !important;
  max-height:0 !important;
  overflow:hidden !important;
  pointer-events:none !important;
}
</style>
</head>

<body>

<div class="banner-carousel" id="bannerCarousel" aria-label="Carrossel de banners">
  <div class="spacer">
    <img src="https://i.ibb.co/4Z8xDjcV/Chat-GPT-Image-12-01-2026-04-49-28.png" alt="" />
  </div>

  <div class="slide active">
    <img src="https://i.ibb.co/4Z8xDjcV/Chat-GPT-Image-12-01-2026-04-49-28.png" alt="Consultas de tarot para clientes VIP" />
  </div>

  <div class="slide">
    <img src="https://i.ibb.co/bMmJcykt/Chat-GPT-Image-10-01-2026-22-08-33.png" alt="Como se consultar" />
  </div>

  <div class="slide">
    <img src="https://i.ibb.co/rRvmn4Q7/56e5b5c7-3199-4b85-a6d8-22608f6c0402.png" alt="Banner adicional" />
  </div>

  <div class="slide" id="slideVip">
    <img src="https://i.ibb.co/cKPNwmMY/Chat-GPT-Image-12-01-2026-07-11-40.png" alt="Consultas de Tarot Exclusivas para Clientes VIP" />
  </div>
</div>

<div class="page">
  <section class="hero">
    <h1>✨ Consultas de Tarot Exclusivas para Clientes VIP ✨</h1>
    <div class="vip-aviso" aria-label="Aviso Leitura Sorteada VIP">
      <a href="https://marcio2307.github.io/cartomantesonline.site/sorteio.html">
        TODA SEXTA-FEIRA, A PARTIR DAS 18H, ROLA A LEITURA SORTEADA VIP!
      </a>
    </div>
  </section>

  <div class="container" id="cards-container"></div>
</div>

<!-- ✅ POPUP -->
<div id="notifPopupWrap" role="dialog" aria-label="Ativar notificações">
  <div id="notifPopup">
    <div class="t">Ativar notificações?</div>
    <div class="d">Receba avisos do painel. (Recomendado para quem instalou o app na tela inicial)</div>
    <div class="row">
      <button id="notifEnable">ATIVAR</button>
      <button id="notifLater">AGORA NÃO</button>
      <button id="notifOk">OK</button>
    </div>
  </div>
</div>

<!-- ✅ Botão flutuante (backup) -->
<button id="notifFab" type="button" aria-label="Ativar notificações">
  <span class="dot"></span>
  <span class="p">Notificações</span>
</button>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ==========================================================
   ✅ REMOÇÃO FORÇADA (se o host injetar de novo, apaga na hora)
========================================================== */
(function bloquearPropagandasInjetadas(){
  const SELECTORS = [
    'fabapp-banner-footer',
    'fabapp-banner-footer video',
    '#ads-container',
    '[id="ads-container"]',
    'iframe[src*="fabapp-ads"]',
    'video[src*="fabapp-ads"]',
    'source[src*="fabapp-ads"]',
    'script[src*="fabapp-ads"]'
  ];
  function remover() {
    for (const sel of SELECTORS) {
      document.querySelectorAll(sel).forEach(el => { try{ el.remove(); }catch{} });
    }
  }
  remover();
  const obs = new MutationObserver(remover);
  obs.observe(document.documentElement, { childList:true, subtree:true });

  let tries = 0;
  const t = setInterval(() => {
    remover();
    tries++;
    if (tries >= 30) clearInterval(t);
  }, 500);
})();

/* ✅ CARROSSEL (8s) */
(function initBannerCarousel(){
  const carousel = document.getElementById('bannerCarousel');
  if(!carousel) return;
  const slides = Array.from(carousel.querySelectorAll('.slide'));
  if(slides.length <= 1) return;
  let i = 0;
  function show(index){ slides.forEach((s, k) => s.classList.toggle('active', k === index)); }
  setInterval(() => { i = (i + 1) % slides.length; show(i); }, 8000);
})();

/* ==========================================================
   ✅ FIREBASE CONFIG (SEU) + init seguro
========================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyA7XSLTDxayTOczs7-sW5s0_nx7nkDgVo",
  authDomain: "coletivo2025-9de23.firebaseapp.com",
  databaseURL: "https://coletivo2025-9de23-default-rtdb.firebaseio.com",
  projectId: "coletivo2025-9de23",
  storageBucket: "coletivo2025-9de23.appspot.com",
  messagingSenderId: "740866367489",
  appId: "1:740866367489:web:963e3f5be80cb35a71e000"
};

let db = null;
let fbOk = false;

try{
  if (firebase.apps && firebase.apps.length) {
    firebase.app();
  } else {
    firebase.initializeApp(firebaseConfig);
  }
  db = firebase.database();
  fbOk = true;
}catch(e){
  // sem debug na tela
}

/* ==========================================================
   ✅ SERVICE WORKER (precisa existir o arquivo service-worker.js)
========================================================== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  });
}

/* ===========================
   LISTA DE CONSULTORES
=========================== */
const consultores = [
  { nome: "P.Márcio", valor: 2, imagem: "https://i.ibb.co/B5wwzSHD/Imagem-do-Whats-App-de-2025-10-31-s-12-44-22-8316baa5.jpg", estrelas: 5 },
  { nome: "Flora", valor: 1, imagem: "https://www.mestresmisticos.com.br/Assets/Imagens/2025/11/06//5dfb048cce-1-_3.webp", estrelas: 5, novo: true },
  { nome: "Carina", valor: 1, imagem: "https://www.mestresmisticos.com.br/Assets/Imagens/2025/12/04//5aea31bd77-1-_3.webp", estrelas: 5, novo: true },
  { nome: "Dalila", valor: 1, imagem: "https://www.mestresmisticos.com.br/Assets/Imagens/2025/10/11//0b284c7b42-1-_3.webp", estrelas: 5, novo: true },
  { nome: "Adria", valor: 1, imagem: "https://www.mestresmisticos.com.br/Assets/Imagens/2025/07/25//d6152621b2-1-_3.webp", estrelas: 5, novo: true },
  { nome: "Thabata", valor: 1, imagem: "https://www.mestresmisticos.com.br/Assets/Imagens/2025/06/28//d5969655ef-1-_3.webp", estrelas: 5, novo: true },
  { nome: "Analu", valor: 1, imagem: "https://www.mestresmisticos.com.br/Assets/Imagens/2025/12/19//fe3f4b6a8a-1-_3.webp", estrelas: 5, novo: true },
  { nome: "Benedita", valor: 1, imagem: "https://www.mestresmisticos.com.br/Assets/Imagens/2025/10/23//9f9ffa4ba9-1-_3.webp", estrelas: 5, novo: true },
  { nome: "Estrela", valor: 1, imagem: "https://www.mestresmisticos.com.br/Assets/Imagens/2026/01/01//b2a24fc4f7-1-_3.webp", estrelas: 5, novo: true },
  { nome: "Sulamita", valor: 1, imagem: "https://www.rainhasdotarot.com.br/Assets/Imagens/2024/05/27//47a447851c-1-.jpg", estrelas: 5 },
  { nome: "Esmeralda", valor: 1, imagem: "https://www.rainhasdotarot.com.br/Assets/Imagens/2020/05/18//41c4696d05-1-.jpg", estrelas: 5 },
  { nome: "M.Padilha", valor: 1, imagem: "https://www.rainhasdotarot.com.br/Assets/Imagens/2025/01/27//699974ac8a-1-.jpg", estrelas: 4 },
  { nome: "Sara", valor: 1, imagem: "https://www.rainhasdotarot.com.br/Assets/Imagens/2024/09/04//9a6f4cec30-1-.jpg", estrelas: 5 },
  { nome: "7 Saias", valor: 1, imagem: "https://www.rainhasdotarot.com.br/Assets/Imagens/2024/02/29//e43513a707-1-.jpg", estrelas: 5 },
  { nome: "Odara", valor: 1, imagem: "https://www.rainhasdotarot.com.br/Assets/Imagens/2024/01/15//91bb2a4455-1-.jpg", estrelas: 5 },
  { nome: "Luara", valor: 1, imagem: "https://www.rainhasdotarot.com.br/Assets/Imagens/2024/08/24//dc4e2cb494-1-.jpg", estrelas: 5 }
];

const container = document.getElementById('cards-container');

consultores.forEach((c, idx) => {
  const card = document.createElement('div');
  card.className = 'card' + (c.novo ? ' novo' : '');
  card.dataset.idx = String(idx);

  card.innerHTML = `
    <div class="img-wrap">
      <img src="${c.imagem}" alt="${c.nome}">
    </div>
    <span class="badge">Online</span>
    <div class="content">
      <div class="name">${c.nome} <span class="dot"></span></div>
      <div class="stars">${'★'.repeat(c.estrelas)}${'☆'.repeat(5 - c.estrelas)}</div>
      <div class="price"><b>R$ ${Number(c.valor).toFixed(2)} por minuto</b></div>
      <a href="#" class="btn disponivel">INICIAR CONSULTA</a>
    </div>
  `;

  card.querySelector('.btn').addEventListener('click', (e) => {
    e.preventDefault();
    if (card.dataset.status !== "online") return;

    localStorage.removeItem('consultorNome');
    localStorage.removeItem('consultorValor');
    localStorage.removeItem('consultorImagem');

    localStorage.setItem('consultorNome', c.nome);
    localStorage.setItem('consultorValor', String(c.valor));
    localStorage.setItem('consultorImagem', c.imagem);

    window.location.href = 'https://marcio2307.github.io/cartomantesonline.site/pacotes.html';
  });

  container.appendChild(card);
});

/* ===========================
   STATUS REALISTA
=========================== */
function chance(p){ return Math.random() < p; }
const STORAGE_KEY = "status_realista_v3";
let estado = null;

function carregarEstado(){
  try{
    const raw = sessionStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(!parsed || !Array.isArray(parsed.consultores)) return null;
    return parsed;
  }catch{ return null; }
}
function salvarEstado(){ try{ sessionStorage.setItem(STORAGE_KEY, JSON.stringify(estado)); }catch{} }

function setStatusDOM(card, status){
  const badge = card.querySelector('.badge');
  const dot = card.querySelector('.dot');
  const btn = card.querySelector('.btn');

  card.dataset.status = status;

  badge.classList.remove('ocupado','indisp');
  dot.classList.remove('ocupado','indisp');
  btn.classList.remove('ocupado','indisp','disponivel');

  dot.style.animation = '';

  if(status === "online"){
    badge.textContent = 'Online';
    dot.style.animation = 'blink 1s infinite';
    btn.textContent = 'INICIAR CONSULTA';
    btn.classList.add('disponivel');
    btn.style.pointerEvents = '';
  }else if(status === "ocupado"){
    badge.textContent = 'Ocupado';
    badge.classList.add('ocupado');
    dot.classList.add('ocupado');
    dot.style.animation = 'none';
    btn.textContent = 'OCUPADO';
    btn.classList.add('ocupado');
    btn.style.pointerEvents = 'none';
  }else{
    badge.textContent = 'Indisponível';
    badge.classList.add('indisp');
    dot.classList.add('indisp');
    dot.style.animation = 'none';
    btn.textContent = 'INDISPONÍVEL';
    btn.classList.add('indisp');
    btn.style.pointerEvents = 'none';
  }
}
function todosIndisponiveisAgora(){
  const h = new Date().getHours();
  return (h >= 2 && h < 10);
}
function initEstado(){
  const dia = new Date().toDateString();
  const anterior = carregarEstado();
  if(anterior && anterior.dia === dia && anterior.consultores?.length === consultores.length){
    estado = anterior;
    return;
  }
  estado = { dia, consultores: consultores.map(() => ({ status:"online", holdUntil:0 })) };
  aplicarStatusRealista(true);
  salvarEstado();
}
function escolherIndisponiveis(cards){
  const total = cards.length;
  const qtd = chance(0.55) ? 1 : 2;
  const indices = [...Array(total)].map((_,i)=>i);
  for(let i=indices.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [indices[i], indices[j]] = [indices[j], indices[i]];
  }
  return new Set(indices.slice(0, Math.min(qtd, total)));
}
function aplicarStatusRealista(forceAll=false){
  const now = Date.now();
  const hora = new Date().getHours();
  const cards = Array.from(document.querySelectorAll('.card'));

  if(todosIndisponiveisAgora()){
    cards.forEach((card, i) => {
      const st = estado.consultores[i];
      st.status = "indisp";
      st.holdUntil = now + 60 * 1000;
      setStatusDOM(card, "indisp");
    });
    salvarEstado();
    return;
  }

  let ocupProb = 0.40;
  if (hora >= 9 && hora < 12) ocupProb = 0.34;
  if (hora >= 12 && hora < 17) ocupProb = 0.44;
  if (hora >= 17 && hora < 22) ocupProb = 0.56;
  if (hora >= 22 || hora < 6) ocupProb = 0.38;

  const indispSet = escolherIndisponiveis(cards);

  cards.forEach((card, i) => {
    const st = estado.consultores[i];
    const emHold = !forceAll && st.holdUntil && now < st.holdUntil;
    if (emHold){ setStatusDOM(card, st.status); return; }

    if (indispSet.has(i)){
      st.status = "indisp";
      st.holdUntil = now + Math.floor((2 + Math.random()*3) * 60 * 1000);
      setStatusDOM(card, "indisp");
      return;
    }

    const novoStatus = chance(ocupProb) ? "ocupado" : "online";
    st.status = novoStatus;
    st.holdUntil = (novoStatus === "ocupado")
      ? now + Math.floor((2 + Math.random()*4) * 60 * 1000)
      : now + Math.floor((1 + Math.random()*2) * 60 * 1000);

    setStatusDOM(card, novoStatus);
  });

  salvarEstado();
}
initEstado();
aplicarStatusRealista(false);
setInterval(() => aplicarStatusRealista(false), 20000);
document.addEventListener('visibilitychange', () => { if (!document.hidden) aplicarStatusRealista(false); });

/* ==========================================================
   ✅ COMUNHÃO COM PAINEL: /devices + /notifications
   CORREÇÕES IMPORTANTES:
   ✅ Agora o painel manda recipients como MAPA {id:true}
   ✅ Aqui a leitura entende MAPA e também broadcast {"*":true}
   ✅ Popup de permissão: se for app instalado, tenta mostrar; se falhar, FAB aparece
   ✅ Sempre abre ./leituras.html ao clicar na notificação
========================================================== */
const NODE_DEVICES = "devices";
const NODE_NOTIFS  = "notifications";
const ONLINE_PING_MS = 20000;

function isStandalone(){
  return (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) || window.navigator.standalone === true;
}
function makeId(){
  return "dev_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
}
function getDeviceId(){
  let id = localStorage.getItem("co_device_id");
  if(!id){
    id = makeId();
    localStorage.setItem("co_device_id", id);
  }
  return id;
}
const deviceId = getDeviceId();

async function upsertDevice(){
  if(!db) return false;
  try{
    await db.ref(`${NODE_DEVICES}/${deviceId}`).update({
      id: deviceId,
      enabled: (("Notification" in window) && Notification.permission === "granted"),
      lastSeen: Date.now(),
      ua: (navigator.userAgent || "").slice(0,220),
      installed: isStandalone()
    });
    return true;
  }catch(e){ return false; }
}
async function pingLastSeen(){
  if(!db) return;
  try{ await db.ref(`${NODE_DEVICES}/${deviceId}`).update({ lastSeen: Date.now() }); }catch(e){}
}

async function enviarNotificacaoLocal(title, body, url){
  if(!("serviceWorker" in navigator)) return;
  if(!("Notification" in window)) return;
  if(Notification.permission !== "granted") return;

  const reg = await navigator.serviceWorker.ready;
  if(reg && reg.active){
    reg.active.postMessage({
      type: "LOCAL_NOTIFY",
      title: title || "Cartomantes Online",
      body: body || "Nova atualização.",
      url: "./leituras.html" // ✅ SEMPRE
    });
  }
}

/* ✅ presença sempre */
(async function bootPresence(){
  if(!fbOk) return;
  const ok = await upsertDevice();
  if(!ok) return;
  pingLastSeen();
  setInterval(pingLastSeen, ONLINE_PING_MS);
  document.addEventListener("visibilitychange", () => { if(!document.hidden) pingLastSeen(); });
})();

/* ==========================================================
   ✅ PERMISSÃO DE NOTIFICAÇÕES (MELHORADO)
   - No app instalado: tenta mostrar popup automaticamente
   - Se o navegador não permitir popup automático, mostra botão flutuante (FAB)
========================================================== */
(function initNotifPermissionUX(){
  const KEY_DONE  = "notif_activated_done_v2";
  const wrap = document.getElementById("notifPopupWrap");
  const btnEnable = document.getElementById("notifEnable");
  const btnLater  = document.getElementById("notifLater");
  const btnOk     = document.getElementById("notifOk");
  const fab       = document.getElementById("notifFab");

  if(!("Notification" in window)) return;

  function fechar(){ if(wrap) wrap.style.display = "none"; }
  function showWrap(){
    if(!wrap) return;
    wrap.style.display = "flex";
  }

  function setFabState(){
    if(!fab) return;
    const granted = (Notification.permission === "granted");
    fab.classList.toggle("enabled", granted);
    fab.style.display = granted ? "none" : "flex";
  }

  async function pedirPermissao(){
    if(Notification.permission === "denied"){
      if(wrap){
        const desc = wrap.querySelector(".d");
        desc.textContent = "Notificações BLOQUEADAS. Vá nas configurações do navegador e permita notificações para este site.";
        if(btnEnable) btnEnable.style.display = "none";
        if(btnLater) btnLater.style.display = "none";
        if(btnOk){
          btnOk.style.display = "block";
          btnOk.onclick = () => fechar();
        }
      }
      setFabState();
      return;
    }

    const perm = await Notification.requestPermission();

    if(perm === "granted"){
      localStorage.setItem(KEY_DONE,"1");
      fechar();
      await upsertDevice();
      setFabState();
      enviarNotificacaoLocal("Notificações ativadas ✅", "Você receberá avisos do painel.", "./leituras.html");
      return;
    }

    if(wrap){
      const desc = wrap.querySelector(".d");
      desc.textContent = "Permissão não concedida. Se estiver bloqueado, libere nas configurações do navegador.";
      if(btnEnable) btnEnable.style.display = "none";
      if(btnLater) btnLater.style.display = "none";
      if(btnOk){
        btnOk.style.display = "block";
        btnOk.onclick = () => fechar();
      }
    }
    setFabState();
  }

  // handlers
  if(btnLater) btnLater.onclick = () => { fechar(); setFabState(); };
  if(btnEnable) btnEnable.onclick = () => pedirPermissao();
  if(fab) fab.onclick = () => { showWrap(); };

  // lógica para aparecer no app instalado:
  // IMPORTANTE: navegadores só deixam pedir permissão após gesto do usuário.
  // Então: mostramos popup automaticamente (visível), mas o request só acontece ao clicar "ATIVAR".
  const done = (localStorage.getItem(KEY_DONE) === "1");
  const granted = (Notification.permission === "granted");
  if(done || granted){
    localStorage.setItem(KEY_DONE,"1");
    fechar();
    setFabState();
    return;
  }

  // Se for app instalado, tenta mostrar popup. Se não, mostra o FAB como fallback.
  if(isStandalone()){
    // mostra popup SEM pedir permissão automaticamente (evita bloqueio)
    showWrap();

    // se por algum motivo o popup ficar invisível, o FAB aparece
    setTimeout(() => setFabState(), 1200);
  }else{
    // fora do modo app: não atrapalha, mas mostra FAB para o usuário ativar quando quiser
    setFabState();
  }
})();

/* ==========================================================
   ✅ ESCUTA PAINEL (/notifications)
   CORREÇÃO: recipients agora pode vir como:
   - MAPA: { "dev_x": true, ... }
   - Broadcast: { "*": true }
========================================================== */
(function listenPanelNotifications(){
  if(!db) return;
  if(!("Notification" in window)) return;

  let lastTs = Number(localStorage.getItem("co_last_notif_ts") || "0");

  db.ref(NODE_NOTIFS).limitToLast(40).on("child_added", async (snap) => {
    const d = snap.val() || {};
    const ts = Number(d.ts || 0);
    if(!ts || ts <= lastTs) return;

    if(Notification.permission !== "granted") return;

    // ✅ aceita MAPA
    const recMap = (d.recipients && typeof d.recipients === "object") ? d.recipients : {};
    const ok = (recMap["*"] === true) || (recMap[deviceId] === true);
    if(!ok) return;

    localStorage.setItem("co_last_notif_ts", String(ts));
    lastTs = ts;

    await enviarNotificacaoLocal(d.title, d.body, "./leituras.html");
  });
})();
</script>

</body>
</html>
