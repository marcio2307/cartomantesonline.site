<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel de NotificaÃ§Ãµes â€” Cartomantes Online</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

<style>
:root{
  --gold-1:#fff0a6;
  --gold-2:#f6e27a;
  --gold-3:#c7a008;
  --bg:#000;
  --card: rgba(0,0,0,.82);
  --line: rgba(199,160,8,.55);
}
*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  background:
    radial-gradient(900px 420px at 15% 10%, rgba(199,160,8,0.20), rgba(0,0,0,0) 60%),
    radial-gradient(900px 420px at 85% 20%, rgba(199,160,8,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(1200px 520px at 50% 120%, rgba(199,160,8,0.10), rgba(0,0,0,0) 65%),
    var(--bg);
  font-family:'Poppins',sans-serif;
  color:#fff;
}

.wrap{
  max-width:780px;
  margin:0 auto;
  padding:16px 12px 28px;
}

h1{
  margin:0 0 12px;
  font-family:'Cinzel', serif;
  font-size:22px;
  line-height:1.15;
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2) 0%, var(--gold-3) 45%, var(--gold-1) 80%);
  -webkit-background-clip:text;
  background-clip:text;
  text-shadow:0 0 22px rgba(199,160,8,0.15);
}

.card{
  position:relative;
  overflow:hidden;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  box-shadow:0 18px 44px rgba(0,0,0,0.60);
}
.card::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(520px 220px at 50% 0%, rgba(246,226,122,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(180px 120px at 18% 18%, rgba(255,240,166,0.08), rgba(0,0,0,0) 70%),
    radial-gradient(180px 120px at 82% 28%, rgba(255,240,166,0.06), rgba(0,0,0,0) 70%);
  opacity:.95;
  pointer-events:none;
}

.stats{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
}
@media (max-width:520px){
  .stats{ grid-template-columns:1fr; }
}

.stat{
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:12px;
  background:rgba(255,255,255,.06);
}
.stat .k{ font-size:12px; opacity:.80; }
.stat .v{
  font-size:24px;
  font-weight:900;
  margin-top:4px;
  color:transparent;
  background-image:linear-gradient(180deg, #f6e27a, #c7a008);
  -webkit-background-clip:text;
  background-clip:text;
}
.stat .s{
  margin-top:6px;
  font-size:12px;
  opacity:.82;
}

hr.sep{
  border:0;
  border-top:1px solid rgba(255,255,255,.08);
  margin:12px 0;
}

label{
  display:block;
  font-size:12px;
  opacity:.82;
  margin-bottom:6px;
}

input, textarea, select{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.55);
  color:#fff;
  outline:none;
  font-family:'Poppins',sans-serif;
}

textarea{ min-height:110px; resize:vertical; }

.actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:10px;
}

.btn{
  height:50px;
  padding:0 14px;
  border-radius:14px;
  border:0;
  font-weight:900;
  letter-spacing:.4px;
  cursor:pointer;
  color:#111;
  background:linear-gradient(180deg, #fff0a6, #c7a008);
  box-shadow: 0 14px 30px rgba(0,0,0,0.55);
  transition:filter .18s ease, transform .12s ease;
}
.btn:active{ transform:translateY(1px); }
.btn:hover{ filter:brightness(1.05); }

.btn.green{
  color:#fff;
  background:linear-gradient(180deg,#2ecc71,#1f9b50);
}
.btn.ghost{
  color:#fff;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:none;
}

.smallline{
  margin-top:10px;
  font-size:12px;
  opacity:.80;
  line-height:1.35;
  border-top:1px solid rgba(255,255,255,.08);
  padding-top:10px;
}
.smallline b{ color:#FFD700; }
</style>
</head>

<body>
<div class="wrap">
  <h1>ðŸ”” Painel de NotificaÃ§Ãµes</h1>

  <div class="card">

    <div class="stats">
      <div class="stat">
        <div class="k">Online agora</div>
        <div class="v" id="vOnline">0</div>
        <div class="s">enabled=true e lastSeen &lt; 70s</div>
      </div>

      <div class="stat">
        <div class="k">Registrados (ativaram)</div>
        <div class="v" id="vRegistered">0</div>
        <div class="s">enabled = true</div>
      </div>
    </div>

    <hr class="sep"/>

    <div>
      <label>TÃ­tulo</label>
      <input id="nTitle" placeholder="Ex: PromoÃ§Ã£o VIP ðŸ”®" value="Cartomantes Online" />
    </div>

    <div style="margin-top:10px;">
      <label>Mensagem</label>
      <textarea id="nBody" placeholder="Digite a mensagem para enviar..."></textarea>
    </div>

    <div style="margin-top:10px;">
      <label>Enviar para</label>
      <select id="nTarget">
        <option value="online">Somente ONLINE agora</option>
        <option value="registered">Todos REGISTRADOS (ativaram)</option>
      </select>
    </div>

    <div class="actions">
      <button class="btn green" id="btnSend">ENVIAR</button>
      <button class="btn" id="btnRefresh">ATUALIZAR</button>
      <button class="btn ghost" id="btnBroadcast" title="Envia recipients {'*':true}">
        BROADCAST (*)
      </button>
    </div>

    <div class="smallline" id="miniInfo">â€”</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ==========================================================
   âœ… PAINEL GERAL (ISOLADO POR APP)
   - LÃŠ:  devices_by_app/geral
   - ENVIA: notifications com app:"geral"
========================================================== */
const APP_ID = "geral";

/* Firebase config (seu) */
const firebaseConfig = {
  apiKey: "AIzaSyA7XSLTDxayTOczs7-sW5s0_nx7nkDgVo",
  authDomain: "coletivo2025-9de23.firebaseapp.com",
  databaseURL: "https://coletivo2025-9de23-default-rtdb.firebaseio.com",
  projectId: "coletivo2025-9de23",
  storageBucket: "coletivo2025-9de23.appspot.com",
  messagingSenderId: "740866367489",
  appId: "1:740866367489:web:963e3f5be80cb35a71e000"
};

/* NÃ³s */
const NODE_DEVICES_BY_APP = "devices_by_app";
const NODE_NOTIFS         = "notifications";

const ONLINE_WINDOW_MS = 70 * 1000;
const LIST_LIMIT = 800;

/* Para onde o clique da notificaÃ§Ã£o vai levar */
const FIXED_CLICK_URL = "leituras.html?pwa=true";

/* UI refs */
const elRegistered = document.getElementById("vRegistered");
const elOnline     = document.getElementById("vOnline");
const nTitle  = document.getElementById("nTitle");
const nBody   = document.getElementById("nBody");
const nTarget = document.getElementById("nTarget");
const miniInfo  = document.getElementById("miniInfo");

function fmtTime(ms){
  if(!ms) return "â€”";
  try{ return new Date(ms).toLocaleTimeString("pt-BR"); }catch{ return "â€”"; }
}

/* Init firebase (robusto) */
let db = null;
let cacheDevices = [];
let lastRefresh = 0;

try{
  if (firebase.apps && firebase.apps.length) {
    firebase.app();
  } else {
    firebase.initializeApp(firebaseConfig);
  }
  db = firebase.database();
  miniInfo.textContent = "âœ… Conectado. Carregando dispositivosâ€¦";
}catch(e){
  console.error(e);
  miniInfo.textContent = "âŒ Erro ao iniciar Firebase. Confira firebaseConfig.";
}

/* refs */
function devicesRootRef(){
  return db.ref(`${NODE_DEVICES_BY_APP}/${APP_ID}`);
}

/* counts */
function computeCounts(devs){
  const now = Date.now();
  const registered = devs.filter(d => d && d.enabled === true).length;
  const online = devs.filter(d => d && d.enabled === true && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS)).length;
  return { registered, online };
}

function refreshCounters(){
  const { registered, online } = computeCounts(cacheDevices);
  elRegistered.textContent = registered;
  elOnline.textContent = online;
  miniInfo.textContent = `Atualizado: ${fmtTime(lastRefresh)} â€¢ Online: ${online} â€¢ Registrados: ${registered} â€¢ app=${APP_ID}`;
}

/* leitura */
async function refreshDevicesOnce(){
  if(!db) return;
  try{
    const query = devicesRootRef().orderByChild("lastSeen").limitToLast(LIST_LIMIT);
    const snap = await new Promise((resolve, reject) => query.once("value", resolve, reject));

    const val = snap.val() || {};
    const arr = Object.entries(val).map(([id, d]) => ({ id, ...d }));
    arr.sort((a,b) => (b.lastSeen||0) - (a.lastSeen||0));

    cacheDevices = arr;
    lastRefresh = Date.now();
    refreshCounters();
  }catch(e){
    console.error(e);
    miniInfo.textContent = "âŒ Erro ao ler devices_by_app/geral. Confira Rules.";
  }
}

function startRealtimeDevices(){
  if(!db) return;
  devicesRootRef().orderByChild("lastSeen").limitToLast(LIST_LIMIT).on("value", (snap) => {
    const val = snap.val() || {};
    const arr = Object.entries(val).map(([id, d]) => ({ id, ...d }));
    arr.sort((a,b) => (b.lastSeen||0) - (a.lastSeen||0));

    cacheDevices = arr;
    lastRefresh = Date.now();
    refreshCounters();
  }, (err) => {
    console.error(err);
    miniInfo.textContent = "âŒ Erro realtime em devices_by_app/geral (Rules).";
  });
}

/* envio */
function buildRecipientsMap(ids){
  const m = {};
  for(const id of ids) m[id] = true;
  return m;
}

async function pushNotification(payload){
  const ref = db.ref(NODE_NOTIFS).push();
  await ref.set(payload);
}

async function sendNotification({title, body, target}){
  if(!db) throw new Error("Sem DB");

  title = (title || "Cartomantes Online").trim();
  body  = (body  || "Nova mensagem.").trim();
  target = target || "online";

  const now = Date.now();
  const devs = cacheDevices || [];

  const registeredIds = devs.filter(d => d && d.enabled === true).map(d => d.id);
  const onlineIds = devs
    .filter(d => d && d.enabled === true && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS))
    .map(d => d.id);

  const ids = (target === "registered") ? registeredIds : onlineIds;

  const payload = {
    app: APP_ID,
    title,
    body,
    url: FIXED_CLICK_URL,
    ts: now,
    target,
    recipients: buildRecipientsMap(ids),
    sentBy: "painel",
    sentAt: now
  };

  await pushNotification(payload);
  miniInfo.textContent = `âœ… Enviado para ${ids.length} dispositivo(s) (${target}) â€¢ app=${APP_ID} â€¢ ${fmtTime(Date.now())}`;
}

/* eventos UI */
document.getElementById("btnSend").onclick = async () => {
  try{
    if(!nBody.value.trim()){
      alert("Digite a mensagem antes de enviar.");
      return;
    }
    if(!cacheDevices.length) await refreshDevicesOnce();
    await sendNotification({
      title: nTitle.value,
      body: nBody.value,
      target: nTarget.value
    });
  }catch(e){
    console.error(e);
    alert("Erro ao enviar. Confira Rules do /notifications.");
  }
};

document.getElementById("btnBroadcast").onclick = async () => {
  try{
    if(!nBody.value.trim()){
      alert("Digite a mensagem antes de enviar.");
      return;
    }
    const now = Date.now();
    await pushNotification({
      app: APP_ID,
      title: (nTitle.value || "Cartomantes Online").trim(),
      body: (nBody.value || "").trim(),
      url: FIXED_CLICK_URL,
      ts: now,
      target: "broadcast",
      recipients: { "*": true },
      sentBy: "painel",
      sentAt: now
    });
    miniInfo.textContent = `âœ… Broadcast (*) enviado â€¢ app=${APP_ID} â€¢ ${fmtTime(Date.now())}`;
  }catch(e){
    console.error(e);
    alert("Erro ao enviar broadcast. Confira Rules.");
  }
};

document.getElementById("btnRefresh").onclick = () => refreshDevicesOnce();

/* boot */
(function boot(){
  if(!db) return;
  startRealtimeDevices();
  refreshDevicesOnce();

  setInterval(() => {
    if(Date.now() - lastRefresh > 20000){
      refreshDevicesOnce();
    }
  }, 15000);
})();
</script>
</body>
</html>
