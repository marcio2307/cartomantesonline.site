<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel ‚Äì Notifica√ß√µes (Cartomantes Online)</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

<style>
:root{
  --gold-1:#fff0a6;
  --gold-2:#f6e27a;
  --gold-3:#c7a008;
  --gold-4:#b8860b;
  --bg:#000;
  --card:rgba(10,10,10,.88);
  --line:rgba(199,160,8,.35);
  --ok:#2ecc71;
  --warn:#f39c12;
  --danger:#e74c3c;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(900px 420px at 15% 10%, rgba(199,160,8,0.20), rgba(0,0,0,0) 60%),
    radial-gradient(900px 420px at 85% 20%, rgba(199,160,8,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(1200px 520px at 50% 120%, rgba(199,160,8,0.10), rgba(0,0,0,0) 65%),
    #000;
  font-family:'Poppins',sans-serif;
  color:#fff;
  padding:18px;
}

.wrap{
  max-width:980px;
  margin:0 auto;
}

.header{
  background:linear-gradient(180deg, rgba(18,18,18,.88), rgba(8,8,8,.96));
  border:1px solid var(--line);
  border-radius:18px;
  padding:18px 16px;
  box-shadow:0 18px 44px rgba(0,0,0,.55);
  margin-bottom:14px;
}
.header h1{
  margin:0 0 6px;
  font-family:'Cinzel',serif;
  font-size:20px;
  letter-spacing:.4px;
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-1) 0%, var(--gold-3) 60%, var(--gold-2) 100%);
  -webkit-background-clip:text;
  background-clip:text;
}
.header p{
  margin:0;
  opacity:.88;
  font-size:13px;
  line-height:1.4;
}
.header .tag{
  display:inline-flex;
  align-items:center;
  gap:8px;
  margin-top:10px;
  font-size:12px;
  font-weight:800;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
}
.dot{
  width:10px;height:10px;border-radius:50%;
  background:var(--warn);
  box-shadow:0 0 14px rgba(243,156,18,.35);
}
.dot.ok{ background:var(--ok); box-shadow:0 0 14px rgba(46,204,113,.35); }
.dot.bad{ background:var(--danger); box-shadow:0 0 14px rgba(231,76,60,.35); }

.grid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap:14px;
}
@media (max-width:880px){
  .grid{ grid-template-columns:1fr; }
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:18px;
  padding:16px;
  box-shadow:0 18px 44px rgba(0,0,0,.55);
}

.card h2{
  margin:0 0 12px;
  font-size:14px;
  letter-spacing:.4px;
  text-transform:uppercase;
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2) 0%, var(--gold-3) 60%, var(--gold-4) 100%);
  -webkit-background-clip:text;
  background-clip:text;
}

.field{ margin-bottom:12px; }
label{
  display:block;
  font-size:12px;
  font-weight:800;
  letter-spacing:.3px;
  margin-bottom:6px;
  opacity:.9;
}
input, textarea{
  width:100%;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:#fff;
  padding:12px 12px;
  outline:none;
  font-size:13px;
}
textarea{ min-height:110px; resize:vertical; }

.row{
  display:flex;
  gap:10px;
}
.row > *{ flex:1; }

.btns{
  display:flex;
  gap:10px;
  margin-top:8px;
  flex-wrap:wrap;
}
button{
  border:0;
  border-radius:14px;
  height:48px;
  padding:0 14px;
  font-weight:900;
  letter-spacing:.6px;
  cursor:pointer;
}
.primary{
  background:linear-gradient(180deg, #2ecc71 0%, #1f9b50 100%);
  color:#fff;
}
.secondary{
  background:rgba(255,255,255,.08);
  color:#fff;
  border:1px solid rgba(255,255,255,.12);
}
.danger{
  background:linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
  color:#fff;
}

.small{
  font-size:12px;
  opacity:.85;
  line-height:1.45;
}

.list{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:10px;
}
.item{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.35);
  border-radius:14px;
  padding:10px 10px;
}
.item .top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:11px;
  font-weight:900;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
}
.pill{
  display:inline-block;
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  opacity:.9;
}
.pill.ok{ color:#0f0; border-color:rgba(46,204,113,.35); }
.pill.warn{ color:#ffdf88; border-color:rgba(243,156,18,.35); }
.pill.gray{ color:#bbb; }
.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:11px; opacity:.9; }
hr.sep{
  border:none;
  border-top:1px solid rgba(255,255,255,.08);
  margin:12px 0;
}
</style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <h1>üõ†Ô∏è Painel de Notifica√ß√µes ‚Äì Cartomantes Online</h1>
    <p>Funciona <b>100% no GitHub Pages</b>: envia aviso para quem estiver com o app/aba aberto (PWA instalado tamb√©m). Sem servidor.</p>
    <div class="tag" id="statusTag">
      <span class="dot" id="statusDot"></span>
      <span id="statusText">Iniciando‚Ä¶</span>
    </div>
  </div>

  <div class="grid">

    <div class="card">
      <h2>Enviar notifica√ß√£o</h2>

      <div class="row">
        <div class="field">
          <label>T√≠tulo</label>
          <input id="title" placeholder="Cartomantes Online" value="Cartomantes Online" />
        </div>
        <div class="field">
          <label>Link ao clicar</label>
          <input id="url" placeholder="./leituras.html" value="./leituras.html" />
        </div>
      </div>

      <div class="field">
        <label>Mensagem</label>
        <textarea id="body" placeholder="Ex: Seu consultor est√° dispon√≠vel agora!"></textarea>
      </div>

      <div class="btns">
        <button class="primary" id="sendBtn">ENVIAR AGORA</button>
        <button class="secondary" id="testBtn">TESTE (PING)</button>
        <button class="danger" id="clearBtn">LIMPAR LISTA</button>
      </div>

      <hr class="sep">

      <div class="small">
        ‚úÖ Envia para <b>apps/abas abertos</b> no mesmo dom√≠nio do GitHub Pages.<br>
        ‚ùå N√£o envia para celular fechado (isso exigiria Push real + servidor).
      </div>
    </div>

    <div class="card">
      <h2>Usu√°rios com notifica√ß√£o ativada (online)</h2>
      <div class="small">
        Essa lista mostra quem <b>ativou</b> e est√° com o app <b>aberto agora</b>.
      </div>

      <div class="list" id="usersList"></div>

      <div class="small" style="margin-top:10px">
        Dica: pe√ßa para o usu√°rio abrir o app e tocar em <b>ATIVAR</b>. A√≠ ele aparece aqui.
      </div>
    </div>

  </div>
</div>

<script>
/* ==========================================================
   ‚úÖ PAINEL 100% GitHub Pages
   - Envia mensagens via BroadcastChannel (tempo real)
   - Fallback via localStorage (quando BroadcastChannel n√£o existir)
   - Mant√©m lista "online" (app aberto) via handshake
========================================================== */

const CHANNEL = "cartomantes_notifs";
const LS_KEY  = "cartomantes_notif_last";
const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(CHANNEL) : null;

const $ = (id) => document.getElementById(id);
const statusDot = $("statusDot");
const statusText = $("statusText");
const usersList = $("usersList");

const titleInput = $("title");
const bodyInput  = $("body");
const urlInput   = $("url");

let onlineUsers = new Map(); // id -> {name, perm, mode, lastSeen}

/* ---------- status UI ---------- */
function setStatus(kind, text){
  statusDot.classList.remove("ok","bad");
  if(kind === "ok") statusDot.classList.add("ok");
  if(kind === "bad") statusDot.classList.add("bad");
  statusText.textContent = text;
}
setStatus(bc ? "ok" : "bad", bc ? "Conectado (BroadcastChannel)" : "Fallback (localStorage)");

/* ---------- helpers ---------- */
function now(){ return Date.now(); }
function uidShort(){ return Math.random().toString(16).slice(2,8).toUpperCase(); }

function broadcast(payload){
  if(bc) bc.postMessage(payload);
  try{
    localStorage.setItem(LS_KEY, JSON.stringify({ ...payload, _ts: now(), _nonce: uidShort() }));
  }catch{}
}

function renderUsers(){
  // remove offline (√∫ltimos 25s)
  const cutoff = now() - 25000;
  for(const [id, u] of onlineUsers.entries()){
    if(u.lastSeen < cutoff) onlineUsers.delete(id);
  }

  const arr = Array.from(onlineUsers.entries())
    .sort((a,b) => (b[1].lastSeen - a[1].lastSeen));

  if(arr.length === 0){
    usersList.innerHTML = `
      <div class="item">
        <div class="top">
          <div class="badge"><span class="dot warn" style="width:9px;height:9px;border-radius:50%"></span> Ningu√©m online</div>
          <span class="pill gray">aguardando‚Ä¶</span>
        </div>
        <div class="small" style="margin-top:8px">
          Abra o app <b>leituras.html</b> no celular, toque em <b>ATIVAR</b> notifica√ß√µes.
        </div>
      </div>
    `;
    return;
  }

  usersList.innerHTML = arr.map(([id, u]) => {
    const perm = u.perm === "granted" ? "ok" : "warn";
    const mode = u.mode || "web";
    return `
      <div class="item">
        <div class="top">
          <div>
            <div style="font-weight:900">${u.name || "Usu√°rio"}</div>
            <div class="mono">ID: ${id} ‚Ä¢ ${mode}</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <span class="pill ${perm}">perm: ${u.perm || "?"}</span>
            <span class="pill gray">online</span>
          </div>
        </div>
        <div class="small" style="margin-top:8px;opacity:.9">
          √öltimo sinal: ${Math.round((now() - u.lastSeen)/1000)}s atr√°s
        </div>
      </div>
    `;
  }).join("");
}

/* ---------- handshake ----------
   O app (leituras.html) deve responder:
   - Quando receber {type:"WHO"}, ele manda {type:"IAM", ...dados}
   - E tamb√©m manda um "IAM" a cada 10s (heartbeat)
*/
function requestWho(){
  broadcast({ type:"WHO" });
}

/* ---------- receive from clients ---------- */
function onIncoming(data){
  if(!data || typeof data !== "object") return;

  if(data.type === "IAM"){
    const id = String(data.id || "").trim();
    if(!id) return;
    onlineUsers.set(id, {
      name: data.name || "Usu√°rio",
      perm: data.perm || "?",
      mode: data.mode || "web",
      lastSeen: now()
    });
    renderUsers();
  }
}

if(bc){
  bc.onmessage = (ev) => onIncoming(ev.data);
}

window.addEventListener("storage", (e) => {
  if(e.key !== LS_KEY) return;
  try{
    const d = JSON.parse(e.newValue || "{}");
    onIncoming(d);
  }catch{}
});

/* ---------- actions ---------- */
$("sendBtn").onclick = () => {
  const title = (titleInput.value || "Cartomantes Online").trim();
  const body  = (bodyInput.value || "Nova atualiza√ß√£o.").trim();
  const url   = (urlInput.value || "./leituras.html").trim();

  broadcast({
    type: "SEND",
    title,
    body,
    url
  });

  // opcional: limpar campo mensagem ap√≥s enviar
  bodyInput.value = "";
};

$("testBtn").onclick = () => {
  requestWho();
};

$("clearBtn").onclick = () => {
  onlineUsers.clear();
  renderUsers();
};

/* ---------- boot ---------- */
renderUsers();
requestWho();
setInterval(() => {
  requestWho();
  renderUsers();
}, 10000);
</script>
</body>
</html>
