<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel de Push â€” Cartomantes Online</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

<style>
:root{
  --gold-1:#fff0a6;
  --gold-2:#f6e27a;
  --gold-3:#c7a008;
  --bg:#000;
  --card: rgba(0,0,0,.82);
  --line: rgba(199,160,8,.55);
}
*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  background:
    radial-gradient(900px 420px at 15% 10%, rgba(199,160,8,0.20), rgba(0,0,0,0) 60%),
    radial-gradient(900px 420px at 85% 20%, rgba(199,160,8,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(1200px 520px at 50% 120%, rgba(199,160,8,0.10), rgba(0,0,0,0) 65%),
    var(--bg);
  font-family:'Poppins',sans-serif;
  color:#fff;
}

.wrap{
  max-width:880px;
  margin:0 auto;
  padding:16px 12px 28px;
}

h1{
  margin:0 0 12px;
  font-family:'Cinzel', serif;
  font-size:22px;
  line-height:1.15;
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2) 0%, var(--gold-3) 45%, var(--gold-1) 80%);
  -webkit-background-clip:text;
  background-clip:text;
  text-shadow:0 0 22px rgba(199,160,8,0.15);
}

.card{
  position:relative;
  overflow:hidden;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  box-shadow:0 18px 44px rgba(0,0,0,0.60);
}
.card::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(520px 220px at 50% 0%, rgba(246,226,122,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(180px 120px at 18% 18%, rgba(255,240,166,0.08), rgba(0,0,0,0) 70%),
    radial-gradient(180px 120px at 82% 28%, rgba(255,240,166,0.06), rgba(0,0,0,0) 70%);
  opacity:.95;
  pointer-events:none;
}

.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}
@media (max-width:680px){ .stats{ grid-template-columns:1fr; } }

.stat{
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:12px;
  background:rgba(255,255,255,.06);
}
.stat .k{ font-size:12px; opacity:.80; }
.stat .v{
  font-size:24px;
  font-weight:900;
  margin-top:4px;
  color:transparent;
  background-image:linear-gradient(180deg, #f6e27a, #c7a008);
  -webkit-background-clip:text;
  background-clip:text;
}
.stat .s{
  margin-top:6px;
  font-size:12px;
  opacity:.82;
}

hr.sep{
  border:0;
  border-top:1px solid rgba(255,255,255,.08);
  margin:12px 0;
}

label{
  display:block;
  font-size:12px;
  opacity:.82;
  margin-bottom:6px;
}

input, textarea, select{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.55);
  color:#fff;
  outline:none;
  font-family:'Poppins',sans-serif;
}

textarea{ min-height:110px; resize:vertical; }

.row{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (max-width:680px){ .row{ grid-template-columns:1fr; } }

.actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:10px;
}

.btn{
  height:50px;
  padding:0 14px;
  border-radius:14px;
  border:0;
  font-weight:900;
  letter-spacing:.4px;
  cursor:pointer;
  color:#111;
  background:linear-gradient(180deg, #fff0a6, #c7a008);
  box-shadow: 0 14px 30px rgba(0,0,0,0.55);
  transition:filter .18s ease, transform .12s ease;
}
.btn:active{ transform:translateY(1px); }
.btn:hover{ filter:brightness(1.05); }

.btn.green{
  color:#fff;
  background:linear-gradient(180deg,#2ecc71,#1f9b50);
}
.btn.ghost{
  color:#fff;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:none;
}
.btn.red{
  color:#fff;
  background:linear-gradient(180deg,#e74c3c,#c0392b);
}

.smallline{
  margin-top:10px;
  font-size:12px;
  opacity:.90;
  line-height:1.4;
  border-top:1px solid rgba(255,255,255,.08);
  padding-top:10px;
  white-space:pre-wrap;
}

.mini{
  font-size:12px;
  opacity:.82;
}
</style>
</head>

<body>
<div class="wrap">
  <h1>ðŸ”” Painel de Push (Realtime â†’ Function sendPush)</h1>

  <div class="card">
    <div class="stats">
      <div class="stat">
        <div class="k">Devices no RTDB</div>
        <div class="v" id="vDevices">0</div>
        <div class="s">Total em /devices</div>
      </div>
      <div class="stat">
        <div class="k">Com FCM Token</div>
        <div class="v" id="vTokens">0</div>
        <div class="s">fcmToken presente</div>
      </div>
      <div class="stat">
        <div class="k">Online recente</div>
        <div class="v" id="vOnline">0</div>
        <div class="s">lastSeen &lt; 70s</div>
      </div>
    </div>

    <hr class="sep"/>

    <div class="row">
      <div>
        <label>TÃ­tulo</label>
        <input id="nTitle" placeholder="Ex: PromoÃ§Ã£o VIP ðŸ”®" value="Cartomantes Online" />
      </div>
      <div>
        <label>URL ao clicar</label>
        <input id="nUrl" placeholder="leituras.html?pwa=true" value="leituras.html?pwa=true" />
        <div class="mini">Dica: mantenha assim para abrir o app na tela de leituras.</div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Mensagem</label>
      <textarea id="nBody" placeholder="Digite a mensagem para enviar...">ðŸ”¥ Teste PUSH com app fechado</textarea>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Enviar para</label>
        <select id="nTarget">
          <option value="broadcast">Broadcast (todos) â€” recipients {"*":true}</option>
          <option value="tokens">Somente quem tem fcmToken</option>
          <option value="onlineTokens">Somente ONLINE (70s) e com fcmToken</option>
        </select>
      </div>
      <div>
        <label>Chave do push (id)</label>
        <input id="nKey" placeholder="deixe vazio para automÃ¡tico" />
        <div class="mini">Se deixar vazio, cria um id automÃ¡tico.</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn green" id="btnSend">ENVIAR PUSH</button>
      <button class="btn" id="btnRefresh">ATUALIZAR CONTADORES</button>
      <button class="btn ghost" id="btnOpenDB">ABRIR RTDB</button>
      <button class="btn red" id="btnClearKey">LIMPAR ID</button>
    </div>

    <div class="smallline" id="miniInfo">â€”</div>
  </div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ==========================================================
   âœ… FIREBASE CONFIG (RTDB DO PROJETO cartomantes-online-675c1)
   (o mesmo que aparece na sua tela do RTDB)
========================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyBeeIiNU_-OfPiQfmn0ORIgJrqCkorsP6U",
  authDomain: "cartomantes-online-675c1.firebaseapp.com",
  databaseURL: "https://cartomantes-online-675c1-default-rtdb.firebaseio.com",
  projectId: "cartomantes-online-675c1",
  storageBucket: "cartomantes-online-675c1.firebasestorage.app",
  messagingSenderId: "801459451704",
  appId: "1:801459451704:web:b6243cc21b61b67fd833cd"
};

const NODE_DEVICES = "devices";
const NODE_NOTIFS  = "notifications";

const ONLINE_WINDOW_MS = 70 * 1000;
const LIST_LIMIT = 2000;

/* ==========================================================
   UI
========================================================== */
const elDevices = document.getElementById("vDevices");
const elTokens  = document.getElementById("vTokens");
const elOnline  = document.getElementById("vOnline");

const nTitle  = document.getElementById("nTitle");
const nBody   = document.getElementById("nBody");
const nTarget = document.getElementById("nTarget");
const nUrl    = document.getElementById("nUrl");
const nKey    = document.getElementById("nKey");
const miniInfo= document.getElementById("miniInfo");

function fmtTime(ms){
  if(!ms) return "â€”";
  return new Date(ms).toLocaleTimeString("pt-BR");
}

/* ==========================================================
   INIT Firebase
========================================================== */
let db = null;
let cacheDevices = [];
let lastRefresh = 0;

try{
  if(!firebase.apps || !firebase.apps.length){
    firebase.initializeApp(firebaseConfig);
  }
  db = firebase.database();
  miniInfo.textContent = "Conectado. Carregando /devicesâ€¦";
}catch(e){
  console.error(e);
  miniInfo.textContent = "Erro ao iniciar Firebase. Confira firebaseConfig.";
}

/* ==========================================================
   DEVICES
========================================================== */
function computeCounts(devs){
  const now = Date.now();
  const total = devs.length;
  const tokens = devs.filter(d => d && d.fcmToken && String(d.fcmToken).length > 20).length;
  const online = devs.filter(d => d && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS)).length;
  return { total, tokens, online };
}

function refreshCounters(){
  const { total, tokens, online } = computeCounts(cacheDevices);
  elDevices.textContent = total;
  elTokens.textContent = tokens;
  elOnline.textContent = online;
  miniInfo.textContent =
    `Atualizado: ${fmtTime(lastRefresh)}\n`+
    `Devices: ${total} | Tokens: ${tokens} | Online(70s): ${online}`;
}

async function refreshDevicesOnce(){
  if(!db) return;
  try{
    const snap = await new Promise((resolve, reject) => {
      db.ref(NODE_DEVICES).limitToLast(LIST_LIMIT).once("value",
        s => resolve(s),
        err => reject(err)
      );
    });
    const val = snap.val() || {};
    const arr = Object.entries(val).map(([id, d]) => ({ id, ...d }));
    arr.sort((a,b) => (b.lastSeen||0) - (a.lastSeen||0));
    cacheDevices = arr;
    lastRefresh = Date.now();
    refreshCounters();
  }catch(e){
    console.error(e);
    miniInfo.textContent = "Erro ao ler /devices. Confira Rules e databaseURL.";
  }
}

function startRealtimeDevices(){
  if(!db) return;
  db.ref(NODE_DEVICES).limitToLast(LIST_LIMIT).on("value", (snap) => {
    const val = snap.val() || {};
    const arr = Object.entries(val).map(([id, d]) => ({ id, ...d }));
    arr.sort((a,b) => (b.lastSeen||0) - (a.lastSeen||0));
    cacheDevices = arr;
    lastRefresh = Date.now();
    refreshCounters();
  }, (err) => {
    console.error(err);
    miniInfo.textContent = "Erro realtime /devices (Rules).";
  });
}

/* ==========================================================
   SEND (cria em /notifications -> dispara Function sendPush)
========================================================== */
function buildRecipientsMapForIds(ids){
  const m = {};
  for(const id of ids) m[id] = true;
  return m;
}

async function createNotification(payload, customKey){
  if(!db) throw new Error("Sem DB");
  if(customKey && customKey.trim()){
    await db.ref(`${NODE_NOTIFS}/${customKey.trim()}`).set(payload);
    return customKey.trim();
  }else{
    const ref = db.ref(NODE_NOTIFS).push();
    await ref.set(payload);
    return ref.key;
  }
}

async function sendPush(){
  if(!db) return;

  const title = (nTitle.value || "Cartomantes Online").trim();
  const body  = (nBody.value  || "Nova mensagem.").trim();
  const url   = (nUrl.value   || "leituras.html?pwa=true").trim();
  const target = nTarget.value || "broadcast";
  const now = Date.now();

  if(!body){
    alert("Digite a mensagem antes de enviar.");
    return;
  }

  const devs = cacheDevices || [];
  const nowMs = Date.now();

  const withTokenIds = devs
    .filter(d => d && d.fcmToken && String(d.fcmToken).length > 20)
    .map(d => d.id);

  const onlineWithTokenIds = devs
    .filter(d => d && d.fcmToken && String(d.fcmToken).length > 20 && (nowMs - (d.lastSeen||0) < ONLINE_WINDOW_MS))
    .map(d => d.id);

  let recipients;
  if(target === "broadcast"){
    recipients = { "*": true };
  }else if(target === "tokens"){
    recipients = buildRecipientsMapForIds(withTokenIds);
  }else{
    recipients = buildRecipientsMapForIds(onlineWithTokenIds);
  }

  const payload = {
    title,
    body,
    url,
    ts: now,
    target,
    recipients,
    sentBy: "painel_html",
    sentAt: now
  };

  const key = await createNotification(payload, nKey.value);

  miniInfo.textContent =
    `âœ… Enviado!\n`+
    `ID: ${key}\n`+
    `Target: ${target}\n`+
    `Agora veja no RTDB: /notifications/${key}/debug (a Function escreve lÃ¡).`;
}

/* ==========================================================
   BUTTONS
========================================================== */
document.getElementById("btnSend").onclick = async () => {
  try{
    if(!cacheDevices.length) await refreshDevicesOnce();
    await sendPush();
  }catch(e){
    console.error(e);
    alert("Erro ao enviar. Confira Rules do RTDB e se a Function estÃ¡ ativa.");
  }
};

document.getElementById("btnRefresh").onclick = () => refreshDevicesOnce();

document.getElementById("btnOpenDB").onclick = () => {
  const url = "https://console.firebase.google.com/project/cartomantes-online-675c1/database/cartomantes-online-675c1-default-rtdb/data";
  window.open(url, "_blank");
};

document.getElementById("btnClearKey").onclick = () => { nKey.value = ""; };

/* ==========================================================
   BOOT
========================================================== */
(function boot(){
  if(!db) return;
  startRealtimeDevices();
  refreshDevicesOnce();
})();
</script>
</body>
</html>
