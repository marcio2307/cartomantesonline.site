<!-- =========================
     ‚úÖ painel.html (COMPLETO / ATUALIZADO) ‚Äî 2026
     - Mobile-first (bonito e f√°cil)
     - Lista /devices em tempo real (sem ‚Äúerro atualizar lista‚Äù)
     - Conta Registrados (enabled=true)
     - Conta Online (enabled=true + lastSeen < 70s)
     - Envia /notifications com recipients EM MAPA (compat√≠vel com Rules)
     - Bot√£o TESTE broadcast "*" (recipients: {"*":true})
     - Link ao clicar: SEMPRE abre leituras.html (for√ßa)
========================= -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel de Notifica√ß√µes ‚Äî Cartomantes Online</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

<style>
:root{
  --gold-1:#fff0a6;
  --gold-2:#f6e27a;
  --gold-3:#c7a008;
  --gold-4:#b8860b;
  --bg:#000;
  --card: rgba(0,0,0,.82);
  --line: rgba(199,160,8,.55);
  --soft: rgba(255,255,255,.10);
  --soft2: rgba(255,255,255,.06);
  --ok:#2ecc71;
  --warn:#f39c12;
  --bad:#e74c3c;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background:
    radial-gradient(900px 420px at 15% 10%, rgba(199,160,8,0.20), rgba(0,0,0,0) 60%),
    radial-gradient(900px 420px at 85% 20%, rgba(199,160,8,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(1200px 520px at 50% 120%, rgba(199,160,8,0.10), rgba(0,0,0,0) 65%),
    var(--bg);
  font-family:'Poppins',sans-serif;
  color:#fff;
}

.wrap{
  max-width:1180px;
  margin:0 auto;
  padding:18px 14px 40px;
}

.header{
  display:flex;
  flex-wrap:wrap;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  margin-bottom:12px;
}
.title{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:min(760px, 100%);
}
h1{
  margin:0;
  font-family:'Cinzel', serif;
  font-size:26px;
  line-height:1.1;
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2) 0%, var(--gold-3) 45%, var(--gold-1) 80%);
  -webkit-background-clip:text;
  background-clip:text;
  text-shadow:0 0 22px rgba(199,160,8,0.15);
}
.sub{
  margin:0;
  opacity:.86;
  font-size:13px;
  line-height:1.35;
}

.pills{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid var(--soft);
  background:rgba(255,255,255,.06);
  font-size:12px;
  font-weight:800;
}
.pill .dot{
  width:9px;height:9px;border-radius:50%;
  background:var(--ok);
  box-shadow:0 0 12px rgba(46,204,113,.35);
}
.pill.off .dot{ background:var(--bad); box-shadow:none; }
.pill strong{
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2), var(--gold-3));
  -webkit-background-clip:text;
  background-clip:text;
}

.grid{
  display:grid;
  grid-template-columns: 1.06fr .94fr;
  gap:14px;
  margin-top:12px;
}
@media (max-width:980px){
  .grid{ grid-template-columns:1fr; }
  .pills{ justify-content:flex-start; }
}

.card{
  position:relative;
  overflow:hidden;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  box-shadow:0 18px 44px rgba(0,0,0,0.60);
}
.card::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(520px 220px at 50% 0%, rgba(246,226,122,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(180px 120px at 18% 18%, rgba(255,240,166,0.08), rgba(0,0,0,0) 70%),
    radial-gradient(180px 120px at 82% 28%, rgba(255,240,166,0.06), rgba(0,0,0,0) 70%);
  opacity:.95;
  pointer-events:none;
}
.card h2{
  margin:0 0 10px;
  font-size:15px;
  letter-spacing:.2px;
  font-weight:900;
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-1), var(--gold-3));
  -webkit-background-clip:text;
  background-clip:text;
}

.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}
@media (max-width:520px){
  .stats{ grid-template-columns:1fr; }
}
.stat{
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:12px;
  background:rgba(255,255,255,.06);
}
.stat .k{ font-size:12px; opacity:.78; }
.stat .v{
  font-size:22px;
  font-weight:900;
  margin-top:4px;
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2), var(--gold-3));
  -webkit-background-clip:text;
  background-clip:text;
}

hr.sep{
  border:0;
  border-top:1px solid rgba(255,255,255,.08);
  margin:12px 0;
}

.note{
  font-size:12px;
  opacity:.85;
  line-height:1.45;
}
.note b{ color:#fff; opacity:1; }

.form{
  display:grid;
  gap:10px;
}
label{
  display:block;
  font-size:12px;
  opacity:.82;
  margin-bottom:6px;
}
input, textarea, select{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.55);
  color:#fff;
  outline:none;
  font-family:'Poppins',sans-serif;
}
textarea{
  min-height:120px;
  resize:vertical;
}

.row2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (max-width:520px){
  .row2{ grid-template-columns:1fr; }
}

.actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:4px;
}
.btn{
  height:50px;
  padding:0 14px;
  border-radius:14px;
  border:0;
  font-weight:900;
  letter-spacing:.4px;
  cursor:pointer;
  color:#111;
  background:linear-gradient(180deg, var(--gold-1), var(--gold-3));
  box-shadow: 0 14px 30px rgba(0,0,0,0.55);
  transition:filter .18s ease, transform .12s ease;
}
.btn:active{ transform:translateY(1px); }
.btn:hover{ filter:brightness(1.05); }
.btn.green{
  color:#fff;
  background:linear-gradient(180deg,#2ecc71,#1f9b50);
}
.btn.ghost{
  color:#fff;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:none;
}
.btn.small{
  height:44px;
  border-radius:12px;
  font-size:13px;
}

.log{
  margin-top:10px;
  font-size:12px;
  line-height:1.35;
  opacity:.92;
  border-top:1px solid rgba(255,255,255,.08);
  padding-top:10px;
  white-space:pre-wrap;
  max-height:240px;
  overflow:auto;
}

/* Lista */
.list-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:10px;
  flex-wrap:wrap;
}
.search{
  width:min(360px, 100%);
}
.table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:12px;
}
.table th, .table td{
  border-bottom:1px solid rgba(255,255,255,.10);
  padding:10px 8px;
  text-align:left;
  vertical-align:top;
}
.table th{ opacity:.85; font-weight:900; }
.badge{
  display:inline-flex;
  align-items:center;
  gap:7px;
  padding:6px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.14);
}
.bdot{
  width:8px;height:8px;border-radius:50%;
  background:var(--ok);
  box-shadow:0 0 10px rgba(46,204,113,.35);
}
.badge.off .bdot{ background:var(--bad); box-shadow:none; }
.badge.on{ background:rgba(46,204,113,.12); }
.badge.off{ background:rgba(231,76,60,.12); }
.badge.reg{ background:rgba(246,226,122,.10); }
.badge.reg .bdot{ background:var(--gold-2); box-shadow:0 0 10px rgba(246,226,122,.25); }

.mini{
  opacity:.75;
  margin-top:4px;
  word-break:break-word;
}

/* Toast */
.toast{
  position:fixed;
  left:50%;
  bottom:16px;
  transform:translateX(-50%);
  z-index:999999;
  background:rgba(0,0,0,.88);
  border:1px solid rgba(199,160,8,.55);
  border-radius:14px;
  padding:12px 14px;
  width:min(520px, calc(100% - 24px));
  box-shadow:0 20px 60px rgba(0,0,0,.65);
  display:none;
}
.toast.show{ display:block; }
.toast .t{ font-weight:900; margin-bottom:4px; }
.toast .d{ font-size:13px; opacity:.9; line-height:1.35; }

</style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div class="title">
      <h1>üîî Painel de Notifica√ß√µes ‚Äî Cartomantes Online</h1>
      <p class="sub">
        Envia aviso para quem <b>ativou notifica√ß√µes</b> (enabled=true).
        <br/>‚úÖ <b>Online</b> = enabled=true e lastSeen &lt; 70s. (App fechado total: s√≥ Push real)
      </p>
    </div>

    <div class="pills">
      <div class="pill" id="pillDb"><span class="dot"></span>Firebase: <strong id="dbState">OK</strong></div>
      <div class="pill off" id="pillLive"><span class="dot"></span>Atualiza√ß√£o: <strong id="liveState">‚Äî</strong></div>
    </div>
  </div>

  <div class="grid">

    <!-- ESQUERDA -->
    <div class="card">
      <h2>üìä Status + Envio</h2>

      <div class="stats">
        <div class="stat">
          <div class="k">Registrados (ativaram)</div>
          <div class="v" id="vRegistered">0</div>
        </div>
        <div class="stat">
          <div class="k">Online agora</div>
          <div class="v" id="vOnline">0</div>
        </div>
        <div class="stat">
          <div class="k">√öltimo envio</div>
          <div class="v" id="vLastSend">‚Äî</div>
        </div>
      </div>

      <hr class="sep"/>

      <div class="note">
        ‚úÖ <b>Registrado</b>: permitiu notifica√ß√µes.<br/>
        ‚úÖ <b>Online</b>: abriu o app/site recentemente (lastSeen &lt; 70s).<br/>
        üìå <b>Link ao clicar</b>: este painel for√ßa sempre <b>./leituras.html</b>.
      </div>

      <hr class="sep"/>

      <h2>üì® Enviar Notifica√ß√£o</h2>

      <div class="form">
        <div>
          <label>T√≠tulo</label>
          <input id="nTitle" placeholder="Ex: Promo√ß√£o VIP üîÆ" value="Cartomantes Online" />
        </div>

        <div>
          <label>Mensagem</label>
          <textarea id="nBody" placeholder="Ex: Consulta liberada! Clique para abrir."></textarea>
        </div>

        <div class="row2">
          <div>
            <label>Enviar para</label>
            <select id="nTarget">
              <option value="online">Somente ONLINE agora</option>
              <option value="registered">Todos REGISTRADOS</option>
            </select>
          </div>
          <div>
            <label>Link ao clicar (travado)</label>
            <input id="nUrl" value="./leituras.html" disabled />
          </div>
        </div>

        <div class="actions">
          <button class="btn green" id="btnSend">ENVIAR AGORA</button>
          <button class="btn ghost" id="btnTest">TESTAR (broadcast)</button>
          <button class="btn" id="btnRefresh">ATUALIZAR LISTA</button>
          <button class="btn ghost small" id="btnClearLog" title="Limpar log">LIMPAR LOG</button>
        </div>

        <div class="log" id="logBox">Log: aguardando‚Ä¶</div>
      </div>
    </div>

    <!-- DIREITA -->
    <div class="card">
      <div class="list-head">
        <div>
          <h2>üë• Dispositivos (Registrados / Online)</h2>
          <div class="note">Dica: para ‚Äúzerar‚Äù todos, apague <b>/devices</b> no Firebase.</div>
        </div>
        <div class="search">
          <label>Buscar device (ID)</label>
          <input id="searchId" placeholder="Digite parte do ID‚Ä¶">
        </div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th style="width:170px;">Device</th>
            <th style="width:130px;">Status</th>
            <th>√öltimo acesso</th>
          </tr>
        </thead>
        <tbody id="tbodyUsers">
          <tr><td colspan="3" style="opacity:.8">Carregando‚Ä¶</td></tr>
        </tbody>
      </table>

    </div>

  </div>
</div>

<div class="toast" id="toast">
  <div class="t" id="toastT">‚Äî</div>
  <div class="d" id="toastD">‚Äî</div>
</div>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ==========================================================
   ‚úÖ FIREBASE CONFIG (o MESMO do site)
========================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyA7XSLTDxayTOczs7-sW5s0_nx7nkDgVo",
  authDomain: "coletivo2025-9de23.firebaseapp.com",
  databaseURL: "https://coletivo2025-9de23-default-rtdb.firebaseio.com",
  projectId: "coletivo2025-9de23",
  storageBucket: "coletivo2025-9de23.appspot.com",
  messagingSenderId: "740866367489",
  appId: "1:740866367489:web:963e3f5be80cb35a71e000"
};

const ONLINE_WINDOW_MS = 70 * 1000;
const LIST_LIMIT = 160;

const NODE_DEVICES = "devices";
const NODE_NOTIFS  = "notifications";

/* ==========================================================
   UI refs
========================================================== */
const elRegistered = document.getElementById("vRegistered");
const elOnline     = document.getElementById("vOnline");
const elLastSend   = document.getElementById("vLastSend");
const tbody        = document.getElementById("tbodyUsers");
const logBox       = document.getElementById("logBox");

const nTitle  = document.getElementById("nTitle");
const nBody   = document.getElementById("nBody");
const nTarget = document.getElementById("nTarget");

const pillDb   = document.getElementById("pillDb");
const pillLive = document.getElementById("pillLive");
const dbState  = document.getElementById("dbState");
const liveState= document.getElementById("liveState");

const searchId = document.getElementById("searchId");

const toast = document.getElementById("toast");
const toastT= document.getElementById("toastT");
const toastD= document.getElementById("toastD");

function toastShow(t,d){
  toastT.textContent = t;
  toastD.textContent = d || "";
  toast.classList.add("show");
  clearTimeout(window.__tst);
  window.__tst = setTimeout(()=>toast.classList.remove("show"), 2600);
}

function log(msg){
  const stamp = new Date().toLocaleString("pt-BR");
  logBox.textContent = `[${stamp}] ${msg}\n` + logBox.textContent;
}

function fmtTime(ms){
  if(!ms) return "‚Äî";
  return new Date(ms).toLocaleString("pt-BR");
}

function safeStr(x){
  return String(x ?? "").replace(/[<>]/g, "");
}

function setFirebaseState(ok, msg){
  if(ok){
    pillDb.classList.remove("off");
    dbState.textContent = "OK";
    if(msg) log(msg);
  }else{
    pillDb.classList.add("off");
    dbState.textContent = "ERRO";
    if(msg) log(msg);
  }
}

/* ==========================================================
   INIT Firebase (com try/catch pra n√£o quebrar)
========================================================== */
let db = null;
try{
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  setFirebaseState(true, "Firebase conectado.");
}catch(e){
  console.error(e);
  setFirebaseState(false, "Falha ao iniciar Firebase (confira firebaseConfig).");
}

/* ==========================================================
   LER /devices em tempo real (resolve ‚Äúerro atualizar lista‚Äù)
========================================================== */
let cacheDevices = [];
let lastRefresh = 0;

function computeCounts(devs){
  const now = Date.now();
  const registered = devs.filter(d => d && d.enabled === true).length;
  const online = devs.filter(d => d && d.enabled === true && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS)).length;
  return { registered, online };
}

function renderTable(devs){
  const now = Date.now();
  const q = (searchId.value || "").trim().toLowerCase();
  const filtered = q ? devs.filter(d => String(d.id||"").toLowerCase().includes(q)) : devs;

  if(!filtered.length){
    tbody.innerHTML = `<tr><td colspan="3" style="opacity:.8">Nenhum dispositivo encontrado.</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(d => {
    const isRegistered = d.enabled === true;
    const isOnline = isRegistered && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS);

    let badge = "";
    if(isOnline){
      badge = `<span class="badge on"><span class="bdot"></span>ONLINE</span>`;
    }else if(isRegistered){
      badge = `<span class="badge reg"><span class="bdot"></span>REGISTRADO</span>`;
    }else{
      badge = `<span class="badge off"><span class="bdot"></span>OFFLINE</span>`;
    }

    const idShort = safeStr(d.id).slice(0,14) + (String(d.id||"").length>14 ? "‚Ä¶" : "");

    return `
      <tr>
        <td><b>${idShort}</b></td>
        <td>${badge}</td>
        <td>
          ${fmtTime(d.lastSeen)}
          <div class="mini">${safeStr(d.ua||"")}</div>
        </td>
      </tr>
    `;
  }).join("");
}

function refreshUI(){
  const devs = cacheDevices || [];
  const { registered, online } = computeCounts(devs);
  elRegistered.textContent = registered;
  elOnline.textContent = online;

  const t = new Date().toLocaleTimeString("pt-BR");
  pillLive.classList.remove("off");
  liveState.textContent = t;

  renderTable(devs);
}

async function refreshDevicesOnce(){
  if(!db) return;
  try{
    const snap = await db.ref(NODE_DEVICES).orderByChild("lastSeen").limitToLast(LIST_LIMIT).get();
    const val = snap.val() || {};
    const arr = Object.entries(val).map(([id, d]) => ({ id, ...d }));
    arr.sort((a,b) => (b.lastSeen||0) - (a.lastSeen||0));
    cacheDevices = arr;
    lastRefresh = Date.now();
    refreshUI();
    log(`Lista atualizada: ${computeCounts(arr).registered} registrados / ${computeCounts(arr).online} online.`);
  }catch(e){
    console.error(e);
    setFirebaseState(false, "ERRO ao atualizar lista (regras/URL).");
    toastShow("Erro", "N√£o foi poss√≠vel ler /devices. Confira Rules e databaseURL.");
  }
}

/* üî• Real-time: escuta mudan√ßas sem ficar ‚Äúdando erro‚Äù em loop */
function startRealtimeDevices(){
  if(!db) return;

  try{
    // se seu Firebase bloquear .on, use o refresh manual (mas normalmente funciona)
    db.ref(NODE_DEVICES).orderByChild("lastSeen").limitToLast(LIST_LIMIT).on("value", (snap) => {
      const val = snap.val() || {};
      const arr = Object.entries(val).map(([id, d]) => ({ id, ...d }));
      arr.sort((a,b) => (b.lastSeen||0) - (a.lastSeen||0));
      cacheDevices = arr;
      lastRefresh = Date.now();
      refreshUI();
    }, (err) => {
      console.error(err);
      setFirebaseState(false, "ERRO real-time (regras).");
    });

    log("Realtime /devices ativado.");
  }catch(e){
    console.error(e);
    log("Realtime falhou. Usando atualiza√ß√£o manual.");
    refreshDevicesOnce();
  }
}

searchId.addEventListener("input", () => renderTable(cacheDevices));

/* ==========================================================
   ENVIAR NOTIFICA√á√ÉO
   ‚úÖ recipients EM MAPA (compat√≠vel com Rules)
   ‚úÖ URL travada em ./leituras.html (sempre)
========================================================== */
function buildRecipientsMap(ids){
  const m = {};
  for(const id of ids) m[id] = true;
  return m;
}

async function sendNotification({title, body, target}){
  if(!db) throw new Error("No DB");
  title = (title || "Cartomantes Online").trim();
  body  = (body  || "Nova mensagem.").trim();
  target = target || "online";

  const devs = cacheDevices.length ? cacheDevices : [];
  const now = Date.now();

  const registeredIds = devs.filter(d => d && d.enabled === true).map(d => d.id);
  const onlineIds = devs
    .filter(d => d && d.enabled === true && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS))
    .map(d => d.id);

  const ids = (target === "registered") ? registeredIds : onlineIds;

  const payload = {
    title,
    body,
    url: "./leituras.html",     // ‚úÖ SEMPRE
    ts: now,
    target,
    recipients: buildRecipientsMap(ids),  // ‚úÖ MAPA
    sentBy: "painel",
    sentAt: now
  };

  const ref = db.ref(NODE_NOTIFS).push();
  await ref.set(payload);

  elLastSend.textContent = new Date(now).toLocaleTimeString("pt-BR");
  log(`Enviado para ${ids.length} dispositivo(s) (${target}).`);
  toastShow("Enviado ‚úÖ", `Foram ${ids.length} dispositivos (${target}).`);
}

document.getElementById("btnSend").onclick = async () => {
  try{
    if(!nBody.value.trim()){
      alert("Digite a mensagem antes de enviar.");
      return;
    }

    // se estiver sem cache, tenta buscar uma vez
    if(!cacheDevices.length) await refreshDevicesOnce();

    await sendNotification({
      title: nTitle.value,
      body: nBody.value,
      target: nTarget.value
    });

  }catch(e){
    console.error(e);
    log("ERRO ao enviar notifica√ß√£o (regras/URL).");
    toastShow("Erro", "N√£o foi poss√≠vel enviar. Confira Rules do /notifications.");
  }
};

document.getElementById("btnTest").onclick = async () => {
  try{
    if(!db) return;
    const now = Date.now();
    const ref = db.ref(NODE_NOTIFS).push();
    await ref.set({
      title: "Teste do Painel ‚úÖ",
      body: "Se o app estiver aberto e com permiss√£o, voc√™ ver√° esta notifica√ß√£o.",
      url: "./leituras.html",     // ‚úÖ SEMPRE
      ts: now,
      target: "test",
      recipients: { "*": true },  // ‚úÖ broadcast MAPA
      sentBy: "painel",
      sentAt: now
    });
    elLastSend.textContent = new Date(now).toLocaleTimeString("pt-BR");
    log("Teste enviado (broadcast '*').");
    toastShow("Teste enviado ‚úÖ", "Broadcast para todos (quando o app estiver aberto).");
  }catch(e){
    console.error(e);
    log("ERRO ao enviar teste (regras/notifications).");
    toastShow("Erro", "N√£o foi poss√≠vel enviar o teste. Confira Rules.");
  }
};

document.getElementById("btnRefresh").onclick = () => refreshDevicesOnce();

document.getElementById("btnClearLog").onclick = () => {
  logBox.textContent = "Log limpo.\n";
  toastShow("Ok", "Log limpo.");
};

/* ==========================================================
   BOOT
========================================================== */
(function boot(){
  if(!db){
    pillLive.classList.add("off");
    liveState.textContent = "sem db";
    return;
  }
  startRealtimeDevices();
  refreshDevicesOnce();
  setInterval(() => {
    // fallback leve: se o realtime falhar em algum browser
    if(Date.now() - lastRefresh > 15000){
      refreshDevicesOnce();
    }
  }, 12000);
})();
</script>

</body>
</html>
