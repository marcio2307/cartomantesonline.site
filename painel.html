<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel de Notifica√ß√µes ‚Äî Cartomantes Online</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

<style>
:root{
  --gold-1:#fff0a6;
  --gold-2:#f6e27a;
  --gold-3:#c7a008;
  --bg:#000;
  --card: rgba(0,0,0,.82);
  --line: rgba(199,160,8,.55);
}
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background:
    radial-gradient(900px 420px at 15% 10%, rgba(199,160,8,0.20), rgba(0,0,0,0) 60%),
    radial-gradient(900px 420px at 85% 20%, rgba(199,160,8,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(1200px 520px at 50% 120%, rgba(199,160,8,0.10), rgba(0,0,0,0) 65%),
    var(--bg);
  font-family:'Poppins',sans-serif;
  color:#fff;
}
.wrap{ max-width:920px; margin:0 auto; padding:16px 12px 28px; }
h1{
  margin:0 0 12px;
  font-family:'Cinzel', serif;
  font-size:22px;
  line-height:1.15;
  color:transparent;
  background-image:linear-gradient(180deg, var(--gold-2) 0%, var(--gold-3) 45%, var(--gold-1) 80%);
  -webkit-background-clip:text;
  background-clip:text;
  text-shadow:0 0 22px rgba(199,160,8,0.15);
}
.card{
  position:relative;
  overflow:hidden;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  box-shadow:0 18px 44px rgba(0,0,0,0.60);
}
.card::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(520px 220px at 50% 0%, rgba(246,226,122,0.16), rgba(0,0,0,0) 60%),
    radial-gradient(180px 120px at 18% 18%, rgba(255,240,166,0.08), rgba(0,0,0,0) 70%),
    radial-gradient(180px 120px at 82% 28%, rgba(255,240,166,0.06), rgba(0,0,0,0) 70%);
  opacity:.95;
  pointer-events:none;
}
.stats{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
}
@media (max-width:880px){ .stats{ grid-template-columns:repeat(2,1fr);} }
@media (max-width:520px){ .stats{ grid-template-columns:1fr; } }
.stat{
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:12px;
  background:rgba(255,255,255,.06);
}
.stat .k{ font-size:12px; opacity:.80; }
.stat .v{
  font-size:24px;
  font-weight:900;
  margin-top:4px;
  color:transparent;
  background-image:linear-gradient(180deg, #f6e27a, #c7a008);
  -webkit-background-clip:text;
  background-clip:text;
}
.stat .s{ margin-top:6px; font-size:12px; opacity:.82; }
hr.sep{ border:0; border-top:1px solid rgba(255,255,255,.08); margin:12px 0; }

label{ display:block; font-size:12px; opacity:.82; margin-bottom:6px; }
input, textarea, select{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.55);
  color:#fff;
  outline:none;
  font-family:'Poppins',sans-serif;
}
textarea{ min-height:110px; resize:vertical; }

.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (max-width:740px){ .grid2{ grid-template-columns:1fr; } }

.actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:10px;
}
.btn{
  height:50px;
  padding:0 14px;
  border-radius:14px;
  border:0;
  font-weight:900;
  letter-spacing:.4px;
  cursor:pointer;
  color:#111;
  background:linear-gradient(180deg, #fff0a6, #c7a008);
  box-shadow: 0 14px 30px rgba(0,0,0,0.55);
  transition:filter .18s ease, transform .12s ease;
}
.btn:active{ transform:translateY(1px); }
.btn:hover{ filter:brightness(1.05); }
.btn.green{ color:#fff; background:linear-gradient(180deg,#2ecc71,#1f9b50); }
.btn.red{ color:#fff; background:linear-gradient(180deg,#e74c3c,#c0392b); }
.btn.ghost{
  color:#fff;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:none;
}
.smallline{
  margin-top:10px;
  font-size:12px;
  opacity:.90;
  line-height:1.35;
  border-top:1px solid rgba(255,255,255,.08);
  padding-top:10px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  font-size:12px;
}
.dot{
  width:9px;height:9px;border-radius:50%;
  background:#2ecc71;
  box-shadow:0 0 10px rgba(46,204,113,.4);
}
.dot.off{ background:#e74c3c; box-shadow:none; }
.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
</style>
</head>

<body>
<div class="wrap">
  <h1>üîî Painel de Notifica√ß√µes (FCM + RTDB)</h1>

  <div class="card">
    <div class="stats">
      <div class="stat">
        <div class="k">Online agora</div>
        <div class="v" id="vOnline">0</div>
        <div class="s">enabled=true e lastSeen &lt; 70s</div>
      </div>

      <div class="stat">
        <div class="k">Registrados</div>
        <div class="v" id="vRegistered">0</div>
        <div class="s">enabled=true</div>
      </div>

      <div class="stat">
        <div class="k">FCM habilitado</div>
        <div class="v" id="vFcm">0</div>
        <div class="s">fcmEnabled=true</div>
      </div>

      <div class="stat">
        <div class="k">FCM + Online</div>
        <div class="v" id="vFcmOnline">0</div>
        <div class="s">push chega ‚Äúapp fechado‚Äù</div>
      </div>
    </div>

    <hr class="sep"/>

    <div class="grid2">
      <div>
        <label>‚úÖ Endpoint da Function (sendPush)</label>
        <input id="fnUrl" class="mono" />
        <div style="margin-top:8px" class="badge">
          <span class="dot" id="fnDot"></span>
          <span id="fnStatus">‚Äî</span>
        </div>
      </div>

      <div>
        <label>‚úÖ URL que abre ao clicar na notifica√ß√£o</label>
        <input id="clickUrl" class="mono" value="leituras.html?pwa=true" />
        <div style="margin-top:8px; opacity:.85; font-size:12px;">
          (o service-worker normaliza isso no scope do GitHub Pages)
        </div>
      </div>
    </div>

    <hr class="sep"/>

    <div>
      <label>T√≠tulo</label>
      <input id="nTitle" placeholder="Ex: Promo√ß√£o VIP üîÆ" value="Cartomantes Online" />
    </div>

    <div style="margin-top:10px;">
      <label>Mensagem</label>
      <textarea id="nBody" placeholder="Digite a mensagem para enviar..."></textarea>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div>
        <label>Enviar para (lista de devices)</label>
        <select id="nTarget">
          <option value="fcm_online">üì≤ FCM + Online agora (recomendado)</option>
          <option value="fcm_all">üì≤ FCM + Todos com FCM</option>
          <option value="online">Somente ONLINE agora (RTDB/local)</option>
          <option value="registered">Todos REGISTRADOS (RTDB/local)</option>
        </select>
      </div>
      <div>
        <label>Modo de envio</label>
        <select id="sendMode">
          <option value="function">‚úÖ Push real (Function ‚Üí FCM)</option>
          <option value="rtdb">RTDB (notifica√ß√£o ‚Äúlocal‚Äù quando o app estiver aberto)</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button class="btn green" id="btnSend">ENVIAR</button>
      <button class="btn" id="btnRefresh">ATUALIZAR</button>
      <button class="btn ghost" id="btnBroadcast" title="recipients {'*':true}">
        BROADCAST (*)
      </button>
      <button class="btn red" id="btnTestFn" title="S√≥ testa se a function responde">
        TESTAR FUNCTION
      </button>
    </div>

    <div class="smallline" id="miniInfo">‚Äî</div>
  </div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ==========================================================
   ‚úÖ CONFIG DO PROJETO (RTDB + Function)
========================================================== */

// üî• ESTE RTDB √â O QUE VOC√ä MOSTROU NO PRINT (cartomantes-online-675c1)
const firebaseConfig = {
  apiKey: "AIzaSyBeeIiNU_-OfPiQfmn0ORIgJrqCkorsP6U",
  authDomain: "cartomantes-online-675c1.firebaseapp.com",
  databaseURL: "https://cartomantes-online-675c1-default-rtdb.firebaseio.com",
  projectId: "cartomantes-online-675c1",
  storageBucket: "cartomantes-online-675c1.firebasestorage.app",
  messagingSenderId: "801459451704",
  appId: "1:801459451704:web:b6243cc21b61b67fd833cd"
};

const PROJECT_ID = "cartomantes-online-675c1";
const DEFAULT_FN_URL = `https://us-central1-${PROJECT_ID}.cloudfunctions.net/sendPush`;

const NODE_DEVICES = "devices";
const NODE_NOTIFS  = "notifications";

const ONLINE_WINDOW_MS = 70 * 1000;
const LIST_LIMIT = 800;

/* ==========================================================
   UI refs
========================================================== */
const elRegistered = document.getElementById("vRegistered");
const elOnline     = document.getElementById("vOnline");
const elFcm        = document.getElementById("vFcm");
const elFcmOnline  = document.getElementById("vFcmOnline");

const nTitle  = document.getElementById("nTitle");
const nBody   = document.getElementById("nBody");
const nTarget = document.getElementById("nTarget");
const sendMode = document.getElementById("sendMode");
const clickUrl = document.getElementById("clickUrl");

const fnUrl   = document.getElementById("fnUrl");
const fnStatus = document.getElementById("fnStatus");
const fnDot = document.getElementById("fnDot");

const miniInfo  = document.getElementById("miniInfo");

fnUrl.value = DEFAULT_FN_URL;

function fmtTime(ms){
  if(!ms) return "‚Äî";
  return new Date(ms).toLocaleTimeString("pt-BR");
}

/* ==========================================================
   INIT Firebase RTDB
========================================================== */
let db = null;
let cacheDevices = [];
let lastRefresh = 0;

try{
  if(!firebase.apps || !firebase.apps.length){
    firebase.initializeApp(firebaseConfig);
  }
  db = firebase.database();
  miniInfo.textContent = "Conectado. Carregando dispositivos‚Ä¶";
}catch(e){
  console.error(e);
  miniInfo.textContent = "Erro ao iniciar Firebase. Confira firebaseConfig.";
}

/* ==========================================================
   Devices: counts + cache
========================================================== */
function computeCounts(devs){
  const now = Date.now();

  const registered = devs.filter(d => d && d.enabled === true).length;
  const online = devs.filter(d => d && d.enabled === true && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS)).length;

  const fcm = devs.filter(d => d && d.fcmEnabled === true && !!d.fcmToken).length;
  const fcmOnline = devs.filter(d => d && d.fcmEnabled === true && !!d.fcmToken && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS)).length;

  return { registered, online, fcm, fcmOnline };
}

function refreshCounters(){
  const { registered, online, fcm, fcmOnline } = computeCounts(cacheDevices);
  elRegistered.textContent = registered;
  elOnline.textContent = online;
  elFcm.textContent = fcm;
  elFcmOnline.textContent = fcmOnline;
  miniInfo.textContent = `Atualizado: ${fmtTime(lastRefresh)} ‚Ä¢ Online: ${online} ‚Ä¢ Registrados: ${registered} ‚Ä¢ FCM: ${fcm} ‚Ä¢ FCM+Online: ${fcmOnline}`;
}

async function refreshDevicesOnce(){
  if(!db) return;
  try{
    const query = db.ref(NODE_DEVICES).orderByChild("lastSeen").limitToLast(LIST_LIMIT);

    const snap = await new Promise((resolve, reject) => {
      query.once("value", (s) => resolve(s), (err) => reject(err));
    });

    const val = snap.val() || {};
    const arr = Object.entries(val).map(([id, d]) => ({ id, ...d }));
    arr.sort((a,b) => (b.lastSeen||0) - (a.lastSeen||0));
    cacheDevices = arr;
    lastRefresh = Date.now();
    refreshCounters();
  }catch(e){
    console.error(e);
    miniInfo.textContent = "Erro ao ler /devices. Confira Rules e databaseURL.";
  }
}

function startRealtimeDevices(){
  if(!db) return;
  db.ref(NODE_DEVICES).orderByChild("lastSeen").limitToLast(LIST_LIMIT).on("value", (snap) => {
    const val = snap.val() || {};
    const arr = Object.entries(val).map(([id, d]) => ({ id, ...d }));
    arr.sort((a,b) => (b.lastSeen||0) - (a.lastSeen||0));
    cacheDevices = arr;
    lastRefresh = Date.now();
    refreshCounters();
  }, (err) => {
    console.error(err);
    miniInfo.textContent = "Erro realtime /devices (Rules).";
  });
}

/* ==========================================================
   Helper: recipients
========================================================== */
function buildRecipientsMap(ids){
  const m = {};
  for(const id of ids) m[id] = true;
  return m;
}
function pickTargetIds(target){
  const devs = cacheDevices || [];
  const now = Date.now();

  const registeredIds = devs.filter(d => d && d.enabled === true).map(d => d.id);
  const onlineIds = devs.filter(d => d && d.enabled === true && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS)).map(d => d.id);

  const fcmIds = devs.filter(d => d && d.fcmEnabled === true && !!d.fcmToken).map(d => d.id);
  const fcmOnlineIds = devs.filter(d => d && d.fcmEnabled === true && !!d.fcmToken && (now - (d.lastSeen||0) < ONLINE_WINDOW_MS)).map(d => d.id);

  if(target === "registered") return registeredIds;
  if(target === "online") return onlineIds;
  if(target === "fcm_all") return fcmIds;
  if(target === "fcm_online") return fcmOnlineIds;

  return onlineIds;
}

/* ==========================================================
   ‚úÖ ENVIO 1: RTDB (para notifica√ß√£o local quando o app estiver aberto)
========================================================== */
async function pushNotificationRTDB(payload){
  const ref = db.ref(NODE_NOTIFS).push();
  await ref.set(payload);
}

/* ==========================================================
   ‚úÖ ENVIO 2: FUNCTION (push real FCM ‚Äì chega ‚Äúapp fechado‚Äù)
   IMPORTANT√çSSIMO:
   - Esta function foi deployada como: sendPush
   - A gente envia JSON simples. Se sua function exigir outro formato,
     me diga o que ela espera que eu adapto.
========================================================== */
async function sendViaFunction({title, body, url, target, ids, broadcast=false}){
  const endpoint = (fnUrl.value || "").trim() || DEFAULT_FN_URL;

  const payload = {
    title,
    body,
    url,               // "leituras.html?pwa=true"
    target,            // ex: "fcm_online"
    broadcast,         // true/false
    recipients: broadcast ? {"*": true} : buildRecipientsMap(ids)
  };

  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  // algumas functions retornam texto, outras json
  const text = await res.text();
  if(!res.ok){
    throw new Error(`Function erro (${res.status}): ${text}`);
  }
  return text;
}

/* ==========================================================
   UI Actions
========================================================== */
async function doSend(isBroadcast=false){
  if(!db) throw new Error("Sem DB");

  const title = (nTitle.value || "Cartomantes Online").trim();
  const body  = (nBody.value || "").trim();
  const target = isBroadcast ? "broadcast" : (nTarget.value || "fcm_online");
  const url = (clickUrl.value || "leituras.html?pwa=true").trim();

  if(!body){
    alert("Digite a mensagem antes de enviar.");
    return;
  }

  if(!cacheDevices.length) await refreshDevicesOnce();

  const ids = isBroadcast ? [] : pickTargetIds(target);
  const now = Date.now();

  // ‚úÖ sempre grava no RTDB /notifications tamb√©m (log do que foi enviado)
  const logPayload = {
    title, body, url,
    ts: now,
    target,
    recipients: isBroadcast ? {"*": true} : buildRecipientsMap(ids),
    sentBy: "painel",
    sentAt: now,
    mode: (sendMode.value || "function")
  };
  await pushNotificationRTDB(logPayload);

  if(sendMode.value === "rtdb"){
    // RTDB ‚Äúlocal‚Äù: √∫til para testar com o app/site aberto
    miniInfo.textContent = `‚úÖ Registrado no RTDB (/notifications). (Modo RTDB/local) ‚Ä¢ ${fmtTime(now)}`;
    return;
  }

  // ‚úÖ Function FCM (push real)
  const ret = await sendViaFunction({
    title, body, url, target,
    ids,
    broadcast: isBroadcast
  });

  miniInfo.textContent =
    `‚úÖ Push enviado via Function. Alvo: ${isBroadcast ? "*" : ids.length + " device(s)"} ‚Ä¢ ${fmtTime(now)} ‚Ä¢ retorno: ${String(ret).slice(0,120)}`;
}

/* ==========================================================
   Testar se a function responde
========================================================== */
async function testFunction(){
  try{
    fnDot.classList.remove("off");
    fnStatus.textContent = "Testando‚Ä¶";
    const endpoint = (fnUrl.value || "").trim() || DEFAULT_FN_URL;

    // tenta um POST ‚Äúleve‚Äù (n√£o precisa enviar push real)
    const res = await fetch(endpoint, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ ping:true })
    });

    const txt = await res.text();
    if(!res.ok) throw new Error(`HTTP ${res.status}: ${txt}`);

    fnDot.classList.remove("off");
    fnStatus.textContent = "OK (respondeu)";
  }catch(e){
    fnDot.classList.add("off");
    fnStatus.textContent = "Falhou (veja console)";
    console.error(e);
    alert("A function n√£o respondeu como esperado. Se ela exigir outro payload, me diga que eu ajusto o painel.");
  }
}

/* ==========================================================
   Bind buttons
========================================================== */
document.getElementById("btnSend").onclick = async () => {
  try{ await doSend(false); }
  catch(e){
    console.error(e);
    alert("Erro ao enviar. Confira Rules do RTDB e se a Function aceita o payload.");
  }
};
document.getElementById("btnBroadcast").onclick = async () => {
  try{ await doSend(true); }
  catch(e){
    console.error(e);
    alert("Erro no broadcast. Confira Rules e Function.");
  }
};
document.getElementById("btnRefresh").onclick = () => refreshDevicesOnce();
document.getElementById("btnTestFn").onclick = () => testFunction();

/* ==========================================================
   Boot
========================================================== */
(function boot(){
  if(!db) return;
  startRealtimeDevices();
  refreshDevicesOnce();

  // testa function automaticamente ao abrir
  setTimeout(testFunction, 500);

  // auto refresh
  setInterval(() => {
    if(Date.now() - lastRefresh > 20000){
      refreshDevicesOnce();
    }
  }, 15000);
})();
</script>
</body>
</html>
